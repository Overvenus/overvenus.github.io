<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Protocol and FSM | Neil</title>
  <meta name="author" content="Neil Shen">
  
  <meta name="description" content="Protocol本文中 Protocol 特指通讯协议。首先简单的介绍一下什么是 Protocol，来看看 WIKI 上是怎么定义它的：

Communications protocol, a defined set of rules and regulations that determine how data is transmitted in telecommunications and computer networking  —WIKI#Protocol

简单的来说，协议是规范数据传输的一套规则。
Finite State Machines (FSM)下面是摘自 WIKI 的对有限状态机的说明：

It is conceived as an abstract machine that can be in one of a finite number of states. The machine is in only one state at a time; the state it is in at any given time is called the current state. It can change from one state to another when initiated by a triggering event or condition; this is called a transition. A particular FSM is defined by a list of its states, and the triggering condition for each transition.    —WIKI#FSM

有限状态机是一种抽象的机器，拥有有限个状态。它在每个确定的时刻有且只有一个状态（当前状态），它的状态会由于输入条件而发生变化。一个状态转移表可以定义一个有限状态机。有点绕，不过按我的理解，有限状态机有两个关键点，状态和输入条件。这两者之间有一套规则束缚着，规则就这个 FSM 的行为。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Protocol and FSM"/>
  <meta property="og:site_name" content="Neil"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Neil" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//cdnjsnet.b0.upaiyun.com/html5shiv/3.7.2/html5shiv.min.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Neil</a></h1>
  <h2><a href="/">Share Somthing Cool.</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/me">Me</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-10-23T13:17:00.000Z"><a href="/2015/10/23/protocol_and_fsm/">2015-10-23</a></time>
      
      
  
    <h1 class="title">Protocol and FSM</h1>
  

    </header>
    <div class="entry">
      
        <!-- Table of Contents -->
        
          <div id="toc" class="toc-article">
          <h1>TOC</h1>
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Protocol"><span class="toc-number">1.</span> <span class="toc-text">Protocol</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Finite_State_Machines_(FSM)"><span class="toc-number">2.</span> <span class="toc-text">Finite State Machines (FSM)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Protocol_and_FSM"><span class="toc-number">3.</span> <span class="toc-text">Protocol and FSM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implement_a_Protocol"><span class="toc-number">4.</span> <span class="toc-text">Implement a Protocol</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Viewservice"><span class="toc-number">5.</span> <span class="toc-text">Viewservice</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Viewservice_FSM"><span class="toc-number">6.</span> <span class="toc-text">Viewservice FSM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后话"><span class="toc-number">7.</span> <span class="toc-text">后话</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ref-"><span class="toc-number">8.</span> <span class="toc-text">Ref.</span></a></li></ol>
          </div>
        
        <h2 id="Protocol">Protocol</h2><p>本文中 Protocol 特指通讯协议。<br>首先简单的介绍一下什么是 Protocol，来看看 WIKI 上是怎么定义它的：</p>
<blockquote>
<p>Communications protocol, a defined set of rules and regulations that determine how data is transmitted in telecommunications and computer networking  —<a href="https://en.wikipedia.org/wiki/Protocol" target="_blank" rel="external">WIKI#Protocol</a></p>
</blockquote>
<p>简单的来说，协议是规范数据传输的一套规则。</p>
<h2 id="Finite_State_Machines_(FSM)">Finite State Machines (FSM)</h2><p>下面是摘自 WIKI 的对有限状态机的说明：</p>
<blockquote>
<p>It is conceived as an abstract machine that can be in one of a finite number of states. The machine is in only one state at a time; the state it is in at any given time is called the current state. It can change from one state to another when initiated by a triggering event or condition; this is called a transition. A particular FSM is defined by a list of its states, and the triggering condition for each transition.    —<a href="https://en.wikipedia.org/wiki/Finite-state_machine" target="_blank" rel="external">WIKI#FSM</a></p>
</blockquote>
<p>有限状态机是一种抽象的机器，拥有有限个状态。它在每个确定的时刻有且只有一个状态（当前状态），它的状态会由于输入条件而发生变化。一个状态转移表可以定义一个有限状态机。<br>有点绕，不过按我的理解，有限状态机有两个关键点，状态和输入条件。这两者之间有一套规则束缚着，规则就这个 FSM 的行为。<br><a id="more"></a></p>
<h2 id="Protocol_and_FSM">Protocol and FSM</h2><p>把 Protocol 和 FSM 写在一起自然是因为它们有着紧密的联系。不准确的来说， Protocol 就是 FSM 的行为，遵循 Protocol 的实体（们）构成了这个 FSM 的抽象机器。</p>
<h2 id="Implement_a_Protocol">Implement a Protocol</h2><p>实现协议不简单，特别是复杂的，持续状态的协议，TCP 算其中一个😂。<br>列一下实现协议的困难点：</p>
<ol>
<li>状态可能有多种。</li>
<li>条件可能有多种。</li>
<li>1, 2组合产生的情况更多！</li>
<li>因逻辑不清而产生的 BUG 难以排查。</li>
<li>复杂协议容易产生高耦合的代码。</li>
</ol>
<p>说了困难点，当然要题解决思路：</p>
<ol>
<li>编写代码前画出状态转移图，理清思路。</li>
<li>编写代码前定好各个函数的作用，及调用范围。</li>
<li>编写代码时避免过早的优化， premature optimization is the root of all evil， Knuth</li>
<li>有 Test case 那自然是极好的。</li>
</ol>
<p>这四点，箭箭射中我膝盖。唉，人啊，为什么痛过之后才知道悔改！（严肃脸）</p>
<h2 id="Viewservice">Viewservice</h2><p>6.824 的 lab2 Part A 让我们实现一个具体的协议。计算机有随时宕机的可能，一旦发生它提供的服务就不可得了。该协议引入主机（Primary）和从机（Backup）机制并及时检查两者的存活状态，使系统服务具有高可用性，下面称这个协议为 <strong>Viewservice</strong>。<br>Viewservice 在某些条件下会产生一个 <strong>View</strong>。View 是一个数据结构，包含主机和从机的地址。<br>下面说一下这个协议要关键的几个点：</p>
<ol>
<li>持续状态协议，当前状态会影响到下一状态。</li>
<li>每次更新 View， Primary 不能为空。</li>
<li>下一个 View 中的 Primary 必须为当前 View 的 Primary 或 Backup。</li>
<li>每个活动的服务器都保存在 viewserver 中，状态是 Primary, Backup, Idle 其中的一种。</li>
<li>当前 View 中的 Primary 和 Backup 同时出错时，服务结束。</li>
</ol>
<p>上面几点并没有完整地描述 Viewservice，但已足够用来阐述 Protocol 和 FSM 之前的关系，想看完整的协议请访问<a href="http://nil.csail.mit.edu/6.824/2015/labs/lab-2.html" target="_blank" rel="external">lab2#Part A</a>.</p>
<h2 id="Viewservice_FSM">Viewservice FSM</h2><p>不难发现 View 就是状态，条件就是 Primary，Backup，Idle三者的存活状态。<br>注意，为了便于理解，这里的 FSM 只是完整的 Viewservice 中的<strong>关键部分（错误处理）</strong>，我去掉了一些无关痛痒的内容，并且我对 Idle 多了一个限制：每个时刻要没有 Idle，要么只有一个，不会有多个存在。但就算这个限制不存在也不会影响最后的正确性。这样做的好处是 Idle 只有两种状态，简化了条件的同时还便于表示（0 or 1） ;-)</p>
<p>由此设三位二进制数：XXX， 分别代表 Primary，Backup和Idle。1为存活，0为出错。</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align:center">Primary</th>
<th style="text-align:center">Backup</th>
<th style="text-align:center">Idle</th>
<th style="text-align:right">XXX</th>
</tr>
</thead>
<tbody>
<tr>
<td>Alive</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:right">111</td>
</tr>
<tr>
<td>Dead</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:right">000</td>
</tr>
</tbody>
</table>
<p>可能输出的状态有四种：</p>
<ol>
<li>100，只有 Primary 存活。</li>
<li>110，Primary 和 Backup 存活，没有 Idle。</li>
<li>111，Primary，Backup 和 Idle 都存活。</li>
<li>00X，Primary 和 Backup， 服务结束。</li>
</ol>
<p>注意： X 代表 0 和 1，00X 就是 000 和 001 的合集</p>
<p>所有可能的条件：</p>
<p> 1.100<br> 2.101<br> 3.110<br> 4.111<br> 5.010<br> 6.011<br> 7.00X</p>
<p>两者产生的状态转移表： 竖为当前状态，横为条件，<code>\</code> 为不会出现的情况</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align:center">100</th>
<th style="text-align:center">101</th>
<th style="text-align:center">110</th>
<th style="text-align:center">111</th>
<th style="text-align:center">010</th>
<th style="text-align:center">011</th>
<th style="text-align:center">00X</th>
</tr>
</thead>
<tbody>
<tr>
<td>100</td>
<td style="text-align:center">110</td>
<td style="text-align:center">\</td>
<td style="text-align:center">100</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">00X</td>
</tr>
<tr>
<td>110</td>
<td style="text-align:center">110</td>
<td style="text-align:center">110</td>
<td style="text-align:center">100</td>
<td style="text-align:center">111</td>
<td style="text-align:center">100</td>
<td style="text-align:center">110</td>
<td style="text-align:center">00X</td>
</tr>
<tr>
<td>111</td>
<td style="text-align:center">110</td>
<td style="text-align:center">110</td>
<td style="text-align:center">100</td>
<td style="text-align:center">111</td>
<td style="text-align:center">100</td>
<td style="text-align:center">110</td>
<td style="text-align:center">00X</td>
</tr>
<tr>
<td>00X</td>
<td style="text-align:center">00X</td>
<td style="text-align:center">00X</td>
<td style="text-align:center">00X</td>
<td style="text-align:center">00X</td>
<td style="text-align:center">00X</td>
<td style="text-align:center">00X</td>
<td style="text-align:center">00X</td>
</tr>
</tbody>
</table>
<p>根据上面的表可以画出状态转移图，更直观地说明这个 FSM</p>
<p><img src="http://ww1.sinaimg.cn/large/7f793092gw1exdcpwse63j21kw15madn.jpg" alt=""></p>
<p>清楚了这个 FSM，各种情况了然于心，设计数据结构，编写代码，实现协议 so easy。</p>
<h2 id="后话">后话</h2><p>Part A部分我花了不少时间，主要还是当初没有理清协议，有多个 Test 通不过，代码结构推到了一遍又一遍。在机缘巧合下（debug下）发现协议和数电中的状态转移图有紧密的联系。然后尝试用状态转移图来表示协议，没想到还真可以。根据状态转移图改善了一下代码，通过各种 Test 快得飞起！这么好的方法不可能没有人比我先想到，查了 google 才知道有个概念叫<em>有限状态机</em>，有门课叫 <em>Protocol Engineering</em>，我的视野还太小。最后发一张 TCP 的状态转移图，感受下 TCP 的复杂性。</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/f/f6/Tcp_state_diagram_fixed_new.svg" alt=""></p>
<h2 id="Ref-">Ref.</h2><blockquote>
<p><a href="http://nil.csail.mit.edu/6.824/2015/labs/lab-2.html" target="_blank" rel="external">lab2#Part A</a></p>
<p><a href="https://en.wikipedia.org/wiki/Protocol" target="_blank" rel="external">WIKI#Protocol</a></p>
<p><a href="https://en.wikipedia.org/wiki/Finite-state_machine" target="_blank" rel="external">WIKI#FSM</a></p>
<p><a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol" target="_blank" rel="external">WIKI#TCP</a></p>
<p><a href="http://pet.ece.iisc.ernet.in/course/E2223/ch.pdf" target="_blank" rel="external">Specification of Protocol Using FSM</a></p>
<p><a href="http://cs.uccs.edu/~cs522/pe/pe.htm" target="_blank" rel="external">Protocol Specification using Sequence Chart or Message Flow DiagramApply Formal Method To Protocol Specification</a></p>
</blockquote>
<p>End.</p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/Algorithms/">Algorithms</a>, <a href="/tags/C-S-笔记/">C.S.笔记</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:neilsh.me">
  </form>
</div>

  

  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Algorithms/" style="font-size: 15px;">Algorithms</a> <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/C-S-笔记/" style="font-size: 20px;">C.S.笔记</a> <a href="/tags/Career/" style="font-size: 10px;">Career</a> <a href="/tags/Go/" style="font-size: 10px;">Go</a> <a href="/tags/MIT/" style="font-size: 15px;">MIT</a> <a href="/tags/Reading/" style="font-size: 10px;">Reading</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/python/" style="font-size: 10px;">python</a>
  </div>
</div>


  <iframe width="100%" height="110" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=110&fansRow=2&ptype=1&speed=0&skin=5&isTitle=0&noborder=1&isWeibo=0&isFans=0&uid=2138648722&verifier=045e79b4&dpc=1"></iframe>

  <div class="widget widget-toc" style="display: none">
  <h3 class="title">文章目录</h3>
  <div class="container" style="padding: 15px 20px;">
  </div>
</div>
<script src="/js/toc.js" type="text/javascript"></script>

  <div class="scrollup"></div>

<script src="/js/scrollup.js" type="text/javascript"></script>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Neil Shen
  
</div>
<div class="clearfix"></div></footer>
  <script src="//upcdn.b0.upaiyun.com/libs/jquery/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'overvenus';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>