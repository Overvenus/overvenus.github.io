<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[Neil]]></title>
  <subtitle><![CDATA[Share Somthing Cool.]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="http://neilsh.me/"/>
  <updated>2015-10-19T11:17:56.000Z</updated>
  <id>http://neilsh.me/</id>
  
  <author>
    <name><![CDATA[Neil Shen]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[Go Note]]></title>
    <link href="http://neilsh.me/2015/10/08/golang_note/"/>
    <id>http://neilsh.me/2015/10/08/golang_note/</id>
    <published>2015-10-08T14:03:00.000Z</published>
    <updated>2015-10-19T11:17:56.000Z</updated>
    <content type="html"><![CDATA[<!--
TODO:
   - ...
-->
<h2 id="new,_make_and_Local_variable"><code>new</code>, <code>make</code> and Local variable</h2><p>In short: new allocates memory; make initializes the slice, map, and channel types; local variable may be not <em>local</em> at all.</p>
<blockquote>
<p><code>new</code>: new(T) allocates zeroed storage for a new item of type T and returns its address, a value of type *T. In Go terminology, it returns a pointer to a newly allocated zero value of type T.</p>
<p><code>make</code>: creates slices, maps, and channels only, and it returns an <em>initialized (not zeroed)</em> value of type T (not *T).  </p>
<p>Local variable: unlike in C, it’s perfectly OK to return the address of a local variable; the storage associated with the variable survives after the function returns. In fact, taking the address of a composite literal allocates a fresh instance each time it is evaluated, so we can combine these last two lines. (e.g., <code>return &amp;File{fd: fd, name: name}</code>)<br> — <a href="https://golang.org/doc/effective_go.html#allocation_new" target="_blank" rel="external">Effective GO#allocation_new</a><br><a id="more"></a></p>
</blockquote>
<h2 id="Stack_or_Heap?">Stack or Heap?</h2><p><a href="https://golang.org/doc/faq#stack_or_heap" target="_blank" rel="external">Golang FAQ#stackheap</a><br><strong>How do I know whether a variable is allocated on the heap or the stack?</strong></p>
<p>From a correctness standpoint, you don’t need to know. Each variable in Go exists as long as there are <em>references</em> to it. The storage location chosen by the implementation is irrelevant to the semantics of the language.</p>
<p>The storage location does have an effect on writing efficient programs. When possible, the Go compilers will allocate variables that are local to a function in that function’s stack frame. However, if the compiler cannot prove that the variable is not referenced after the function returns, then the compiler must allocate the variable on the garbage-collected heap to avoid dangling pointer errors. Also, if a local variable is very large, it might make more sense to store it on the heap rather than the stack.</p>
<p>In the current compilers, if a variable has its address taken, that variable is a candidate for allocation on the heap. However, a basic escape analysis recognizes some cases when such variables will not live past the return from the function and can reside on the stack.</p>
<p>An excellent talk about stack and heap of Go. <a href="http://dave.cheney.net/2014/06/07/five-things-that-make-go-fast" target="_blank" rel="external">Five things that make Go fast</a></p>
<h2 id="Happen_before_and_Channel">Happen before and Channel</h2><p><a href="https://golang.org/ref/mem#tmp_7" target="_blank" rel="external">Golang Memory Model#channel</a></p>
<blockquote>
<p>A send on a channel happens before the corresponding receive from that channel completes.</p>
</blockquote>
<p>An interesting case where <em>Happen Before</em> will take place.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="typename">int</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="typename">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> f() &#123;</span><br><span class="line">    a = <span class="string">"hello, world"</span></span><br><span class="line">    &lt;-c</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    <span class="keyword">go</span> f()</span><br><span class="line">    c &lt;- <span class="number">0</span></span><br><span class="line">    <span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This snippet guarantes to print “hello, world”. The write to a happens before the receive on c, which happens before the corresponding send on c completes, which happens before the print.<br>If the channel were buffered (e.g., <code>c = make(chan int, 1)</code>) then the program would not be guaranteed to print “hello, world”. (It might print the empty string, crash, or do something else.)</p>
<h2 id="Concurrency">Concurrency</h2><p><a href="https://talks.golang.org/2012/concurrency.slide" target="_blank" rel="external">Go Concurrency Patterns</a></p>
<h3 id="main_exits"><code>main</code> exits</h3><p>What happens to goroutines that running background when main function returns?</p>
<blockquote>
<p>When the main returns, the programm goes away.<br>       — <a href="https://youtu.be/f6kdp27TYZs?t=7m46s" target="_blank" rel="external">Rob Pike#main_exit</a></p>
</blockquote>
<p>It confused me for a long time, now I get a concrete answer.</p>
<h3 id="Generator_in_Go">Generator in Go</h3><blockquote>
<p>Generator: function that returns a channel.<br>Channels are first-class values, just like strings or integers.</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"math/rand"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    <span class="comment">// Python-like usage</span></span><br><span class="line">    <span class="keyword">for</span> s := <span class="keyword">range</span> boring(<span class="string">"generator"</span>) &#123;</span><br><span class="line">        fmt.Println(s)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"func main exits"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ### Generator ###</span></span><br><span class="line"><span class="keyword">func</span> boring(msg <span class="typename">string</span>) &lt;-<span class="keyword">chan</span> <span class="typename">string</span> &#123; <span class="comment">// Returns receive-only channel of strings.</span></span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="typename">string</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="keyword">func</span>() &#123; <span class="comment">// We launch the goroutine from inside the function.</span></span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">            c &lt;- fmt.Sprintf(<span class="string">"%s %d"</span>, msg, i)</span><br><span class="line">            time.Sleep(time.Duration(rand.Intn(<span class="number">1e3</span>)) * time.Millisecond)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(c) <span class="comment">// close channel c, otherwise for-range will be blocked.</span></span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">return</span> c <span class="comment">// Return the channel to the caller.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Unlike <strong>Generator</strong> in Python, the concept in Go is simple: <em>Generator: function that returns a channel</em>.</p>
<ul>
<li>Python Generator: generates data in time.</li>
<li>Go Generator: return a channel, reveives data in time.</li>
</ul>
<h3 id="Tricky_Keyword,_select">Tricky Keyword, <code>select</code></h3><blockquote>
<p>Select<br>The select statement provides another way to handle multiple channels.<br>It’s like a switch, but each case is a communication: </p>
<ul>
<li>All channels are evaluated. </li>
<li>Selection blocks until one communication can proceed, which then does. </li>
<li>If multiple can proceed, select chooses pseudo-randomly. </li>
<li>A default clause, if present, executes immediately if no channel is ready.</li>
</ul>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> v1 := &lt;-c1:</span><br><span class="line">        fmt.Printf(<span class="string">"received %v from c1\n"</span>, v1)</span><br><span class="line">    <span class="keyword">case</span> v2 := &lt;-c2:</span><br><span class="line">        fmt.Printf(<span class="string">"received %v from c2\n"</span>, v1)</span><br><span class="line">    <span class="keyword">case</span> c3 &lt;- <span class="number">23</span>:</span><br><span class="line">        fmt.Printf(<span class="string">"sent %v to c3\n"</span>, <span class="number">23</span>)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        fmt.Printf(<span class="string">"no one was ready to communicate\n"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Select with <strong>default</strong> is a non-blocking statement, even if no other case can be processed. Without <strong>default</strong>, select block forever if no other case can be processed.</p>
<p>END.</p>
]]></content>
    <summary type="html">
    <![CDATA[<!--
TODO:
   - ...
-->
<h2 id="new,_make_and_Local_variable"><code>new</code>, <code>make</code> and Local variable</h2><p>In short: new allocates memory; make initializes the slice, map, and channel types; local variable may be not <em>local</em> at all.</p>
<blockquote>
<p><code>new</code>: new(T) allocates zeroed storage for a new item of type T and returns its address, a value of type *T. In Go terminology, it returns a pointer to a newly allocated zero value of type T.</p>
<p><code>make</code>: creates slices, maps, and channels only, and it returns an <em>initialized (not zeroed)</em> value of type T (not *T).  </p>
<p>Local variable: unlike in C, it’s perfectly OK to return the address of a local variable; the storage associated with the variable survives after the function returns. In fact, taking the address of a composite literal allocates a fresh instance each time it is evaluated, so we can combine these last two lines. (e.g., <code>return &amp;File{fd: fd, name: name}</code>)<br> — <a href="https://golang.org/doc/effective_go.html#allocation_new">Effective GO#allocation_new</a><br>]]>
    
    </summary>
    
      <category term="Go" scheme="http://neilsh.me/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ReadingFragment Structured Computer Organization]]></title>
    <link href="http://neilsh.me/2015/09/21/fragment_structured_Computer_Organization/"/>
    <id>http://neilsh.me/2015/09/21/fragment_structured_Computer_Organization/</id>
    <published>2015-09-21T11:44:00.000Z</published>
    <updated>2015-10-19T11:13:36.000Z</updated>
    <content type="html"><![CDATA[<h1 id="Parallelism_in_Computer_Organization">Parallelism in Computer Organization</h1><p>Why we need parallel computing? Because we are close to the limit of physics — the speed of light and memory becomes the bottleneck of computer.</p>
<h2 id="Parallelism_in_CPU">Parallelism in CPU</h2><ul>
<li>Pipeline<ul>
<li>Sinlge pipeline</li>
<li>Mutli-pipeline</li>
<li>Superscalar pipeline</li>
</ul>
</li>
<li>Array Computers, single control unit and a array of processor.</li>
<li>Multiprocessors, multiple CPUs shared with one common  main memory, and communicate through BUS.</li>
</ul>
<h2 id="Parallelism_in_Memory">Parallelism in Memory</h2><ul>
<li>Modern CPUs has it’s own private memory, cache.</li>
<li>Redundant Array of Inexpensive Disk(RAID), there are 5 level of RAID. I will be surprised if one system supports all 5 level RAID, especially level 2 and 3 ;-)<ul>
<li>Level 0, strips data(typically, a sector) over disks in round robin fashion. No backups.</li>
<li>Level 1, make an additional redundant backup of level 0.</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h1 id="IJVM">IJVM</h1><p><strong>IJVM</strong> is short for <em>Integer instructions only Java Virtual Machine</em>.</p>
<h2 id="IJVM_Memory_Model">IJVM Memory Model</h2><p>It looks like IJVM has a set of different stack operations compares with other machines. IJVM instructions can access memory only by indexing from some special registers. CPP, LV and SP point to word(4 bytes).</p>
<ul>
<li>The constant pool, addressing by CPP, it is loaded when the program is brought into memory and read-only afterward.</li>
<li>The Local variable frame, addressing by LV.</li>
<li>The operand stack, addressing by SP. Push and pop actions take place in this stack.</li>
<li>The method area, consider as the “TEXT” area in UNIX’s memory, addressing by PC. The first 2 byte indicating the number of parameters for the method, the second 2 bytes indicating the size of the local variables, opcode begins at the 5th byte.</li>
</ul>
<h2 id="IJVM_method_invocation">IJVM method invocation</h2><p>Instead of using <code>CALL</code> instraction, JVM use <code>INVOKEVIRTUAL</code>. Below is a brief explanation of method invocation(highly recommad reading <a href="http://users.cis.fiu.edu/~prabakar/cda4101/Common/notes/lecture20.html" target="_blank" rel="external">CDA-4101 Lecture 20 Notes</a>)</p>
<ol>
<li>Push <code>PC</code>, <code>LV</code>, <code>OBJREF</code>(reference of the method’s object) and parameters into Local variable frame.</li>
<li>Build a new Local variable frame, the size of the new frame are determined by the second 2 bytes reading from The method area, and stores the caller’s PC ans LV in the top of the new frame. Replace <code>OBJREF</code> with <code>Link ptr</code> which points to the caller’s PC. Now <code>LV</code> points to <code>Link ptr</code> and <code>SP</code> points to caller’s LV.</li>
<li><code>PC</code> points to 5th byte in the method area.</li>
<li>Mark the new local variables frame as the current frame by seting <code>LV</code> with the address of <code>OBJREF</code>.</li>
</ol>
<p>After the method is done, the return value will be stored in <code>OBJREF</code> (<code>Link ptr</code>).</p>
<h2 id="Some_Qs_about_JVM">Some Qs about JVM</h2><ol>
<li>Give the Java statement that produced the following IJVM code:<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ILOAD <span class="literal">j</span></span><br><span class="line">ILOAD <span class="keyword">n</span></span><br><span class="line">ISUB</span><br><span class="line">BIPUSH 7</span><br><span class="line">ISUB</span><br><span class="line">DUP</span><br><span class="line">IADD</span><br><span class="line">ISTORE <span class="literal">i</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>A: <code>i = (j - n - 7) x 2;</code></p>
<ol>
<li>The JVM <code>INVOKEVIRTUAL</code> instruction needs to know how many parameters it has. Why?</li>
</ol>
<p>A: Old <code>PC</code> and <code>LV</code> will be stored on address of the top of local variables which will be computed by adding the size of local variables and <strong>parameters</strong>.</p>
<h1 id="Intel_Core_i7">Intel Core i7</h1><p>Core i7 is a CPU with CISC outside and RISC inside. In side the chip, there is a decoder which build a bridge between CISC instructions and RISC data path.</p>
<h1 id="Ref-">Ref.</h1><blockquote>
<p>Structured Computer Organization(6th Edition) by Andrew S. Tanenbaum<br><a href="http://users.cis.fiu.edu/~prabakar/cda4101/Common/notes/lecture20.html" target="_blank" rel="external">CDA-4101 Lecture 20 Notes</a></p>
</blockquote>
<p>个人笔记，难免有误，如有发现，还望指出。<br>END.</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="Parallelism_in_Computer_Organization">Parallelism in Computer Organization</h1><p>Why we need parallel computing? Because we are close to the limit of physics — the speed of light and memory becomes the bottleneck of computer.</p>
<h2 id="Parallelism_in_CPU">Parallelism in CPU</h2><ul>
<li>Pipeline<ul>
<li>Sinlge pipeline</li>
<li>Mutli-pipeline</li>
<li>Superscalar pipeline</li>
</ul>
</li>
<li>Array Computers, single control unit and a array of processor.</li>
<li>Multiprocessors, multiple CPUs shared with one common  main memory, and communicate through BUS.</li>
</ul>
<h2 id="Parallelism_in_Memory">Parallelism in Memory</h2><ul>
<li>Modern CPUs has it’s own private memory, cache.</li>
<li>Redundant Array of Inexpensive Disk(RAID), there are 5 level of RAID. I will be surprised if one system supports all 5 level RAID, especially level 2 and 3 ;-)<ul>
<li>Level 0, strips data(typically, a sector) over disks in round robin fashion. No backups.</li>
<li>Level 1, make an additional redundant backup of level 0.</li>
</ul>
</li>
</ul>]]>
    
    </summary>
    
      <category term="Reading" scheme="http://neilsh.me/tags/Reading/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[jupyter-core 4.0.6 的发布]]></title>
    <link href="http://neilsh.me/2015/09/18/jupyter_core_406/"/>
    <id>http://neilsh.me/2015/09/18/jupyter_core_406/</id>
    <published>2015-09-18T12:39:00.000Z</published>
    <updated>2015-10-19T11:13:36.000Z</updated>
    <content type="html"><![CDATA[<h1 id="Jupyter_与_IPython">Jupyter 与 IPython</h1><p>Jupyter 是由 IPython 演化而来的，两者配合使用可提供交互式的编程体验，实现视觉化编程，写了什么，马上就能看见效果。Jupyter 类似于客户端，IPython 作为 Jupyter 的内核。之前 IPython 的杀手锏 notebook 现在转移到 Jupyter 中了。该神器不仅对 data science 有奇效，对于一般的 python 应用开发也有极大的帮助，它同样适合用于学习 python，其易用性直追 PyCharm。</p>
<h1 id="BUG？">BUG？</h1><p>IPython 今年初的时候就有所接触，不过用了几天就卸载了，那时用的还是 IPython notebook。昨天由于课程需要，想在本地安装 IPython。习惯性地 GOOGLE， 打开 IPython 的官网，查看安装教程 <a href="https://jupyter.readthedocs.org/en/latest/install.html" target="_blank" rel="external">Installation</a> ，没想到居然跳转到了 Jupyter 的文档，当时就大吃一斤，再仔细一看，尼玛连 IPython 官网的名字都变了。</p>
<blockquote>
<p><a href="https://ipython.org/" target="_blank" rel="external">Jupyter and the future of IPython - IPython</a></p>
</blockquote>
<p>一直以来就知道 python 的世界变化快，可没想到居然这么快，没几个月，项目的名称都变了。 ∑(￣□￣;)<br><a id="more"></a><br>按照教程，<code>pip install jupyter</code>，一切都很顺利，顺利到让我不敢相信，安装 python 第三方模块在我印象中都是挺蛋疼的。<br>果不其然，安装完之后，一运行 <code>jupter notebook</code> 就报错了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ jupyter notebook</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"/usr/local/bin/jupyter-notebook"</span>, line <span class="number">11</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    sys.exit(main())</span><br><span class="line">  File <span class="string">"/usr/local/lib/python2.7/dist-packages/jupyter_core/application.py"</span>, line <span class="number">267</span>, <span class="keyword">in</span> launch_instance</span><br><span class="line">    <span class="keyword">return</span> super(JupyterApp, cls).launch_instance(argv=argv, **kwargs)</span><br><span class="line">  File <span class="string">"/usr/local/lib/python2.7/dist-packages/traitlets/config/application.py"</span>, line <span class="number">591</span>, <span class="keyword">in</span> launch_instance</span><br><span class="line">    app.initialize(argv) File <span class="string">"&lt;string&gt;"</span>, line <span class="number">2</span>, <span class="keyword">in</span> initialize</span><br><span class="line">  File <span class="string">"/usr/local/lib/python2.7/dist-packages/traitlets/config/application.py"</span>, line <span class="number">75</span>, <span class="keyword">in</span> catch_config_error</span><br><span class="line">    <span class="keyword">return</span> method(app, *args, **kwargs)</span><br><span class="line">  File <span class="string">"/usr/local/lib/python2.7/dist-packages/notebook/notebookapp.py"</span>, line <span class="number">1001</span>, <span class="keyword">in</span> initialize</span><br><span class="line">    super(NotebookApp, self).initialize(argv) File <span class="string">"&lt;string&gt;"</span>, line <span class="number">2</span>, <span class="keyword">in</span> initialize</span><br><span class="line">  File <span class="string">"/usr/local/lib/python2.7/dist-packages/traitlets/config/application.py"</span>, line <span class="number">75</span>, <span class="keyword">in</span> catch_config_error</span><br><span class="line">    <span class="keyword">return</span> method(app, *args, **kwargs)</span><br><span class="line">  File <span class="string">"/usr/local/lib/python2.7/dist-packages/jupyter_core/application.py"</span>, line <span class="number">243</span>, <span class="keyword">in</span> initialize</span><br><span class="line">    self.migrate_config()</span><br><span class="line">  File <span class="string">"/usr/local/lib/python2.7/dist-packages/jupyter_core/application.py"</span>, line <span class="number">169</span>, <span class="keyword">in</span> migrate_config</span><br><span class="line">    migrate() </span><br><span class="line">  File <span class="string">"/usr/local/lib/python2.7/dist-packages/jupyter_core/migrate.py"</span>, line <span class="number">232</span>, <span class="keyword">in</span> migrate</span><br><span class="line">    <span class="keyword">if</span> migrate_static_custom(custom_src, custom_dst): </span><br><span class="line">  File <span class="string">"/usr/local/lib/python2.7/dist-packages/jupyter_core/migrate.py"</span>, line <span class="number">160</span>, <span class="keyword">in</span> migrate_static_custom</span><br><span class="line">    <span class="keyword">if</span> custom_css_empty:</span><br><span class="line">UnboundLocalError: local variable <span class="string">'custom_css_empty'</span> referenced before assignment</span><br></pre></td></tr></table></figure></p>
<p>一看有 css，直觉告诉我，可能是 Jinjia2 之类关于网页处理的模块出错了，于是卸载再重装，还是有此错误。pip 试了几遍不行，apt-get 试了几遍也不行。谷歌来谷歌去都找不到答案，项目的 issus 也翻了一遍，同样没结果，前前后后花了一个多小时，挺沮丧的。</p>
<h1 id="BUG_fix">BUG fix</h1><p>连重装大法都不行，这该不会是 BUG 吧？细细看了一边 traceback，再配合源码一看，立刻就知道哪里可能出错了。<br>原来 Jupyter 在第一次运行时会检测之前是否用过 IPython，如果用过，那就把旧的配置转换成新的。把旧版 IPython 配置文件夹删了之后，再运行<code>jupyter notebook</code>，一切正常。顺手修了这个 BUG。</p>
<h1 id="Create_a_Pull_Request">Create a Pull Request</h1><p>既然修了 BUG，那肯定要向项目开发者反馈啊，要为开源世界做贡献！ Github 主页也能好看点。 (΄◞ิ౪◟ิ‵)<br>过程也很简单：</p>
<ol>
<li>创建该 BUG 的 issus（可选，建议创建）</li>
<li>fork <a href="https://github.com/jupyter/jupyter_core" target="_blank" rel="external">jupyter-core</a></li>
<li>clone 自己的项目到本地</li>
<li>修补 BUG</li>
<li>git push origin</li>
<li>点击项目右侧的 pull request ，创建 pull request</li>
</ol>
<p>这成了我的第一个 Pull Request。现在 jupyter-core 最新的版本是 4.0.6， 感觉这就是为我发布的。我也成了 jupyter 核心模块的贡献者，呵呵。</p>
<h1 id="Ref-">Ref.</h1><blockquote>
<p><a href="https://ipython.org/" target="_blank" rel="external">https://ipython.org/</a><br><a href="https://jupyter.org/index.html" target="_blank" rel="external">https://jupyter.org/index.html</a><br><a href="https://jupyter.readthedocs.org/en/latest/install.html" target="_blank" rel="external">https://jupyter.readthedocs.org/en/latest/install.html</a><br><a href="https://yangsu.github.io/pull-request-tutorial/" target="_blank" rel="external">Pull Request Tutorial - A Visual Guide to Pull Requests</a></p>
</blockquote>
<p>个人笔记，难免有误，如有发现，还望指出。<br>END.</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="Jupyter_与_IPython">Jupyter 与 IPython</h1><p>Jupyter 是由 IPython 演化而来的，两者配合使用可提供交互式的编程体验，实现视觉化编程，写了什么，马上就能看见效果。Jupyter 类似于客户端，IPython 作为 Jupyter 的内核。之前 IPython 的杀手锏 notebook 现在转移到 Jupyter 中了。该神器不仅对 data science 有奇效，对于一般的 python 应用开发也有极大的帮助，它同样适合用于学习 python，其易用性直追 PyCharm。</p>
<h1 id="BUG？">BUG？</h1><p>IPython 今年初的时候就有所接触，不过用了几天就卸载了，那时用的还是 IPython notebook。昨天由于课程需要，想在本地安装 IPython。习惯性地 GOOGLE， 打开 IPython 的官网，查看安装教程 <a href="https://jupyter.readthedocs.org/en/latest/install.html">Installation</a> ，没想到居然跳转到了 Jupyter 的文档，当时就大吃一斤，再仔细一看，尼玛连 IPython 官网的名字都变了。</p>
<blockquote>
<p><a href="https://ipython.org/">Jupyter and the future of IPython - IPython</a></p>
</blockquote>
<p>一直以来就知道 python 的世界变化快，可没想到居然这么快，没几个月，项目的名称都变了。 ∑(￣□￣;)<br>]]>
    
    </summary>
    
      <category term="git" scheme="http://neilsh.me/tags/git/"/>
    
      <category term="python" scheme="http://neilsh.me/tags/python/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Few words about 6.828]]></title>
    <link href="http://neilsh.me/2015/08/30/few_words_about_6_828/"/>
    <id>http://neilsh.me/2015/08/30/few_words_about_6_828/</id>
    <published>2015-08-30T14:14:00.000Z</published>
    <updated>2015-10-19T11:13:36.000Z</updated>
    <content type="html"><![CDATA[<p>Recently I’ve been working on JOS, which is part of <a href="http://pdos.csail.mit.edu/6.828/2014/index.html" target="_blank" rel="external">6.828: Operating System Engineering</a>. 6.828 is a great course about OS, it brings principle to practice, you will implement a simple OS in this course. It also talks about the most fancy research of OS. I recommend every CS sutdent to take this course.</p>
<a id="more"></a>
<h2 id="6-828简介">6.828简介</h2><p>好了，装逼完毕。我认真说说最近上的这门课，6.828是 MIT 开放课程中的一部分，它开放了说有关于该课程的资料，包括上课视频。我个人认为这是一门极好的关于操作系统课程，经典书籍上的知识在这将不再枯燥，它是一门操作系统课程，同时也广泛地涉及了CS中的其他内容，包括但不限于网络，安全，分布式计算等等。</p>
<h2 id="知新">知新</h2><h3 id="寻找资料的正确姿势">寻找资料的正确姿势</h3><p>课程实验中有许多地方并没有说得很仔细，只有大概的意图，实现的细节需要你自己去查阅资料。比如说汇编里面的 <code>call</code> <code>ret</code> 对 <code>ESP``EBP``EIP</code>三个寄存器的影响，它指出了这两个指令于函数调用上、传递参数有关，然后它让你写一个栈回溯函数。<br>Google <code>ret call</code> 的第一个结果：<a href="http://www.c-jump.com/CIS77/ASM/Procedures/P77_0010_call_ret.htm" target="_blank" rel="external">CALL and RET Instructions</a></p>
<blockquote>
<p>CALL pushes the return address onto the stack and transfers control to a procedure.<br>RET pops the return address off the stack and returns control to that location.</p>
</blockquote>
<p>嗯，很好，把 <code>call</code> 和 <code>ret</code> 所干的事说了一下，但是太模糊了，比如说 return address 指向哪里，怎样来 transfers control ， pops the return address 到哪里？这些都没有说清楚。对于初学者来说，这个结果只能做参考，并不能直接拿来用。<br>后来经过一番查找后找到了图文并茂的资料。<a href="http://unixwiz.net/techtips/win32-callconv-asm.html" target="_blank" rel="external">Intel x86 Function-call Conventions - Assembly View</a> 其中 Calling a __cdecl function 那一节讲得很清楚:<br><img src="http://ww1.sinaimg.cn/large/7f793092gw1evo1wpue9bg20770cm3yd.gif" alt=""></p>
<blockquote>
<p>16(%ebp)    - third function parameter<br>12(%ebp)    - second function parameter<br>8(%ebp)    - first function parameter</p>
</blockquote>
<p>一图胜千言，函数调用，参数传递，<code>ESP``EBP``EIP</code>都给说明白了。对比一下前面引用的资料，完全符合。现在我们可以理解，为什么栈要从高向低生长，C 语言中参数为什么从右向左压入栈，函数内的本地变量占用的内存为什么不需要手动管理，这一切都是紧密相关的。</p>
<h3 id="C_的黑魔法">C 的黑魔法</h3><p>C 语言作为入门课在大一上学期时就学了，教材是谭浩强的，他的书在网上被喷的狗血淋头，我也觉得这不是本好教材，借了本 B&amp;D 的 《The C Programming Language》，囫囵吞枣地看了一遍，指针、结构体、联合体、枚举等概念倒背如流，期末的时候拿了高分，自以为 C 学得还不错。现在想来，那时还是太年轻，操作系统里漫天的指针，结构体、联合体互相的嵌套更是少不了，各种神奇的写法见都没见过。下面来几个简单的例子：</p>
<h4 id="给结构体初始化时给指定成员赋值：">给结构体初始化时给指定成员赋值：</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> foo &#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> u;</span><br><span class="line">    <span class="keyword">char</span> *str;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bar</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *s = <span class="string">"Hello!"</span>;</span><br><span class="line">    <span class="keyword">struct</span> foo f = &#123;</span><br><span class="line">        .str = s;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="跨源文件调用匿名结构体变量：">跨源文件调用匿名结构体变量：</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义在 a.c 中</span></span><br><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> us[<span class="number">99</span>];</span><br><span class="line">&#125; foo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 b.c 中</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">unsigned</span> us[<span class="number">99</span>];</span><br><span class="line">&#125; foo;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bar</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, foo.i);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="关键字_volatile">关键字 volatile</h4><blockquote>
<p>the volatile keyword indicates that a value may change between different accesses, even if it does not appear to be modified. This keyword prevents an optimizing compiler from optimizing away subsequent reads or writes and thus incorrectly reusing a stale value or omitting writes.    — <a href="https://en.wikipedia.org/wiki/Volatile_(computer_programming" target="_blank" rel="external">Wikipedia</a>)</p>
</blockquote>
<p>引用指出 volatile 是为了防止编译“优化”对该变量的一系列读写操作。上面抛出一大段结论，还是挺令人疑惑的。什么叫 may change between different accesses， 什么叫 optimizing away subsequent reads or writes？这一切用“底层“的汇编来解释反而容易。<br><a href="/asset/code/v_int.c">带有 volatile</a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// volatile_int.c</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">int</span> foo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 总计4次对 foo 的操作</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    foo = <span class="number">0xff</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, foo);</span><br><span class="line">    foo = <span class="number">0xff</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, foo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译</span></span><br><span class="line">$ gcc -O1 volatile_int.c -o volatile_int</span><br><span class="line"><span class="comment"># 查看汇编</span></span><br><span class="line">$ objdump -S volatile_int &gt; v.asm</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">000000000040055d &#60;main&#62;:&#10;  40055d:&#9;48 83 ec 08          &#9;sub    $0x8,%rsp&#10;  400561:&#9;c7 05 d9 0a 20 00 ff &#9;movl   $0xff,0x200ad9(%rip)        # 601044 &#60;foo&#62;&#10;  400568:&#9;00 00 00 &#10;  40056b:&#9;8b 15 d3 0a 20 00    &#9;mov    0x200ad3(%rip),%edx        # 601044 &#60;foo&#62;&#10;  400571:&#9;be 34 06 40 00       &#9;mov    $0x400634,%esi&#10;  400576:&#9;bf 01 00 00 00       &#9;mov    $0x1,%edi&#10;  40057b:&#9;b8 00 00 00 00       &#9;mov    $0x0,%eax&#10;  400580:&#9;e8 db fe ff ff       &#9;callq  400460 &#60;__printf_chk@plt&#62;&#10;  400585:&#9;c7 05 b5 0a 20 00 ff &#9;movl   $0xff,0x200ab5(%rip)        # 601044 &#60;foo&#62;&#10;  40058c:&#9;00 00 00 &#10;  40058f:&#9;8b 15 af 0a 20 00    &#9;mov    0x200aaf(%rip),%edx        # 601044 &#60;foo&#62;&#10;  400595:&#9;be 34 06 40 00       &#9;mov    $0x400634,%esi&#10;  40059a:&#9;bf 01 00 00 00       &#9;mov    $0x1,%edi&#10;  40059f:&#9;b8 00 00 00 00       &#9;mov    $0x0,%eax&#10;  4005a4:&#9;e8 b7 fe ff ff       &#9;callq  400460 &#60;__printf_chk@plt&#62;&#10;  4005a9:&#9;48 83 c4 08          &#9;add    $0x8,%rsp&#10;  4005ad:&#9;c3                   &#9;retq   &#10;  4005ae:&#9;66 90                &#9;xchg   %ax,%ax</span><br></pre></td></tr></table></figure>
<p><a href="/asset/code/nv_int.c">不带 volatile</a><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">000000000040055d &#60;main&#62;:&#10;  40055d:&#9;48 83 ec 08          &#9;sub    $0x8,%rsp&#10;  400561:&#9;c7 05 d9 0a 20 00 ff &#9;movl   $0xff,0x200ad9(%rip)        # 601044 &#60;foo&#62;&#10;  400568:&#9;00 00 00 &#10;  40056b:&#9;ba ff 00 00 00       &#9;mov    $0xff,%edx&#10;  400570:&#9;be 34 06 40 00       &#9;mov    $0x400634,%esi&#10;  400575:&#9;bf 01 00 00 00       &#9;mov    $0x1,%edi&#10;  40057a:&#9;b8 00 00 00 00       &#9;mov    $0x0,%eax&#10;  40057f:&#9;e8 dc fe ff ff       &#9;callq  400460 &#60;__printf_chk@plt&#62;&#10;  400584:&#9;c7 05 b6 0a 20 00 ff &#9;movl   $0xff,0x200ab6(%rip)        # 601044 &#60;foo&#62;&#10;  40058b:&#9;00 00 00 &#10;  40058e:&#9;ba ff 00 00 00       &#9;mov    $0xff,%edx&#10;  400593:&#9;be 34 06 40 00       &#9;mov    $0x400634,%esi&#10;  400598:&#9;bf 01 00 00 00       &#9;mov    $0x1,%edi&#10;  40059d:&#9;b8 00 00 00 00       &#9;mov    $0x0,%eax&#10;  4005a2:&#9;e8 b9 fe ff ff       &#9;callq  400460 &#60;__printf_chk@plt&#62;&#10;  4005a7:&#9;48 83 c4 08          &#9;add    $0x8,%rsp&#10;  4005ab:&#9;c3                   &#9;retq   &#10;  4005ac:&#9;0f 1f 40 00          &#9;nopl   0x0(%rax)</span><br></pre></td></tr></table></figure></p>
<p>对比可见，带有 volatile 的对 foo 有四次操作，而不带的只有 2 次，从这个例子可以看出一些端倪， volatile 确保了 C 源码中每次对 foo 的操作都是直接对 foo 内存地址的操作。</p>
<h4 id="指针与数组">指针与数组</h4><p>用伪码来简述一下两者的关系。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">char *pc = <span class="number">0</span>；</span><br><span class="line">int *<span class="constant">pi</span> = <span class="number">0</span>;</span><br><span class="line">int ai[<span class="number">5</span>] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line"></span><br><span class="line">(pc += <span class="number">1</span>) == <span class="number">1</span> <span class="keyword">is</span> <span class="constant">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sizeof(int) == <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">then</span> <span class="constant">pi</span> + <span class="number">1</span> == <span class="number">4</span> <span class="keyword">is</span> <span class="constant">true</span>; ((int *)pc) + <span class="number">1</span> == <span class="number">5</span> <span class="keyword">is</span> <span class="constant">true</span>;</span><br><span class="line"></span><br><span class="line">*ai == <span class="number">0</span> <span class="keyword">is</span> <span class="constant">true</span></span><br><span class="line"></span><br><span class="line"><span class="constant">pi</span> = ai</span><br><span class="line">    <span class="keyword">then</span> *<span class="constant">pi</span> == <span class="number">0</span>, <span class="constant">pi</span>[<span class="number">1</span>] == <span class="number">1</span>, <span class="constant">pi</span>[<span class="number">4</span>] == <span class="number">4</span> are <span class="constant">true</span>;</span><br></pre></td></tr></table></figure>
<p>自从学了6.828后，指针再也不是洪水猛兽，自以为余已达收发自如的境界。</p>
<h3 id="杂项">杂项</h3><p>对各种计算机术语有了新的认识：process、thread、stub、trap、caller、callee、coroutine等等。<br>各种命令：man、git、make、gcc、objdump等等。特别是man，我还是第一次知道，man还能当编程手册，查看函数的用法。<br>理论与实践之间的差异，工程上的权衡于妥协。</p>
<h2 id="一些资源">一些资源</h2><p><a href="http://pdos.csail.mit.edu/6.828/2014/index.html" target="_blank" rel="external">官方网站</a><br><a href="https://www.youtube.com/playlist?list=PLfciLKR3SgqNJKKIKUliWoNBBH1VHL3AP" target="_blank" rel="external">课程视频</a><br><a href="https://bitbucket.org/overvenus/jos/" target="_blank" rel="external">我的 JOS (已完成lab1～5，lab6还在编写中)</a></p>
<p>最后，再次感谢 MIT 的教师职员们，并以一张 JOS 靓照结尾。</p>
<p><img src="http://ww1.sinaimg.cn/large/7f793092gw1evohw0nih7j20k00bw75r.jpg" alt=""></p>
<p>个人笔记，难免有误，如有发现，还望指出。<br>END.</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>Recently I’ve been working on JOS, which is part of <a href="http://pdos.csail.mit.edu/6.828/2014/index.html">6.828: Operating System Engineering</a>. 6.828 is a great course about OS, it brings principle to practice, you will implement a simple OS in this course. It also talks about the most fancy research of OS. I recommend every CS sutdent to take this course.</p>]]>
    
    </summary>
    
      <category term="C.S.笔记" scheme="http://neilsh.me/tags/C-S-%E7%AC%94%E8%AE%B0/"/>
    
      <category term="MIT" scheme="http://neilsh.me/tags/MIT/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[第一份实习]]></title>
    <link href="http://neilsh.me/2015/08/29/my_frist_internship/"/>
    <id>http://neilsh.me/2015/08/29/my_frist_internship/</id>
    <published>2015-08-29T06:33:00.000Z</published>
    <updated>2015-10-19T11:13:36.000Z</updated>
    <content type="html"><![CDATA[<p>两个月一晃而过，暑假结束了，第一份实习也结束了。</p>
<p>这段时间，我在 EasyLinking 实习，得到了 FULL TIME 的安卓开发工作经历，真真切切地认识到<strong>文档和注释</strong>重要性，同时还结识了一帮前辈：重视人才的纪总，平和的游总，自学成才的 iOS 大牛老王，后台开发大牛老邹和小胡，开发资历第一丁老师，全栈的北大高材生超哥，等等。</p>
<p>实习中给我印象最深的还是团队协作。不得不说，这个技术团队成员之间协助效率非常高，一个问题发现之后，马上就能得到反馈，我想这应该得利于扁平化的管理模式。</p>
<p>既然我实习的是安卓开发，那就说一下关于安卓的事吧。广播是一个安卓应用的重要组成部分，之前没有开发过业务逻辑复杂的应用，对本地广播的理解也就停留在 <a href="https://developer.android.com/reference/android/support/v4/content/LocalBroadcastManager.html" target="_blank" rel="external">文档</a> 上面，经过这次实习，我已经 understand from practice ，它很强大，也很危险，不愧被称为安卓中的 <code>goto</code>(泪目，掉过坑)。对安卓的触屏事件也有了<a href="/2015/08/13/dispatch_and_handle_motionevent_in_android/">进一步的认识</a>。我还成功地劝服了安卓开发组，把 IDE 从 Eclipse 迁移到 AndroidStudio。:-)</p>
<p>在工作之余，我实现了一个小型的操作系统 <a href="https://bitbucket.org/overvenus/jos/" target="_blank" rel="external">JOS</a>。由于白天没有空，JOS 的代码大部分是在晚上写的，每天都写到凌晨，导致 Work-life balance 很糟糕，脸上冒出了一些痘痘。</p>
<p>总的来说，这是一个有意义的暑假。</p>
<p>END.</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>两个月一晃而过，暑假结束了，第一份实习也结束了。</p>
<p>这段时间，我在 EasyLinking 实习，得到了 FULL TIME 的安卓开发工作经历，真真切切地认识到<strong>文档和注释</strong>重要性，同时还结识了一帮前辈：重视人才的纪总，平和的游总]]>
    </summary>
    
      <category term="Career" scheme="http://neilsh.me/tags/Career/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Android触屏事件处理分发--以SwipeRefreshLayout为例]]></title>
    <link href="http://neilsh.me/2015/08/13/dispatch_and_handle_motionevent_in_android/"/>
    <id>http://neilsh.me/2015/08/13/dispatch_and_handle_motionevent_in_android/</id>
    <published>2015-08-13T06:33:00.000Z</published>
    <updated>2015-10-19T11:13:36.000Z</updated>
    <content type="html"><![CDATA[<h2 id="PullToRefresh_与_SwipeRefreshLayout">PullToRefresh 与 SwipeRefreshLayout</h2><p>这段时间我在 Easyinking 公司实习， 做安卓开发。之前的 App 中大量使用 <a href="https://github.com/chrisbanes/Android-PullToRefreshhttps://github.com/chrisbanes/Android-PullToRefresh" target="_blank" rel="external">Android-PullToRefresh</a>。这个轮子很经典，在较久版本的安卓上面也很好使，不过作者已经放弃维护了，在我们的 App 上也发现了一个诡异的BUG：与WebView配合使用时，在网络环境差的情况下会出现一次下拉多次刷新的情况，症状就是整个网页在那上下抽搐。在官方支持库 support-v4:22 中自带了一个类似的 SwipeRefreshLayout，效果也是一级棒。由于两者的 API 设计差不多，使用的情景也几乎一样，所以可以无痛地从 <a href="https://github.com/chrisbanes/Android-PullToRefreshhttps://github.com/chrisbanes/Android-PullToRefresh" target="_blank" rel="external">PullToRefresh</a> 转移过来。</p>
<h2 id="敏感的_SwipeRefreshLayout">敏感的 SwipeRefreshLayout</h2><p>从 PullToRefresh 转移到 SwipeRefreshLayout 大概花了十来分钟，初步测试出来的效果也令人满意。但是，实际使用中总会有意想不到的问题。我们把一个WebView放在了 SwipeRefreshLayout 中， 该 WebView 呈现的网页中有一个图片轮播，可左右滑动，下面的问题是 SwipeRefreshLayout 过于敏感，它把稍有下拉倾向的左右滑动全部拦截掉，并把他们当作下拉的手势，典型的 False Positive ， 处理的思路也很简单，既然是误报，过滤之即可。</p>
<h3 id="误报的手势"><strong>误报的手势</strong></h3><p><img src="http://ww1.sinaimg.cn/bmiddle/7f793092gw1ev1xydoiwoj20u01hcwoe.jpg" alt=""><img src="http://ww3.sinaimg.cn/bmiddle/7f793092gw1ev1ys28bm4j20u01hc12q.jpg" alt=""></p>
<h3 id="理想中的手势"><strong>理想中的手势</strong></h3><p><img src="http://ww1.sinaimg.cn/bmiddle/7f793092gw1ev1ytgovwpj20u01hcgve.jpg" alt=""></p>
<a id="more"></a>
<h2 id="SwipeRefreshLayout_刷新的细节">SwipeRefreshLayout 刷新的细节</h2><p>SwipeRefreshLayout 有个自定义接口 SwipeRefreshLayout.OnRefreshListener，里面的函数<code>onRefresh()</code>会在下拉刷新时执行。SwipeRefreshLayout 把 OnRefreshListener 包装进了<code>AnimationListener mRefreshListener</code>，并且<code>onRefresh()</code>方法只会在<code>onAnimationEnd()</code>中执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Animation.AnimationListener mRefreshListener = <span class="keyword">new</span> Animation.AnimationListener() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animation animation)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationRepeat</span><span class="params">(Animation animation)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animation animation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mRefreshing) &#123;</span><br><span class="line">            <span class="comment">// Make sure the progress view is fully visible</span></span><br><span class="line">            mProgress.setAlpha(MAX_ALPHA);</span><br><span class="line">            mProgress.start();</span><br><span class="line">            <span class="keyword">if</span> (mNotify) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mListener.onRefresh();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mProgress.stop();</span><br><span class="line">            mCircleView.setVisibility(View.GONE);</span><br><span class="line">            setColorViewAlpha(MAX_ALPHA);</span><br><span class="line">            <span class="comment">// Return the circle to its start position</span></span><br><span class="line">            <span class="keyword">if</span> (mScale) &#123;</span><br><span class="line">                setAnimationProgress(<span class="number">0</span> <span class="comment">/* animation complete and view is hidden */</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                setTargetOffsetTopAndBottom(mOriginalOffsetTop - mCurrentTargetOffsetTop,</span><br><span class="line">                        <span class="keyword">true</span> <span class="comment">/* requires update */</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mCurrentTargetOffsetTop = mCircleView.getTop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 创建刷新指示图标    </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createProgressView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mCircleView = <span class="keyword">new</span> CircleImageView(getContext(), CIRCLE_BG_LIGHT, CIRCLE_DIAMETER/<span class="number">2</span>);</span><br><span class="line">    mProgress = <span class="keyword">new</span> MaterialProgressDrawable(getContext(), <span class="keyword">this</span>);</span><br><span class="line">    mProgress.setBackgroundColor(CIRCLE_BG_LIGHT);</span><br><span class="line">    mCircleView.setImageDrawable(mProgress);</span><br><span class="line">    mCircleView.setVisibility(View.GONE);</span><br><span class="line">    addView(mCircleView);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 listener 注册在<code>mCircleView</code>，负责了<strong>两个动画</strong>，一个是下拉回弹的动画，另一个是刷新转圈的动画。下拉回弹动画的完成，代表触发了刷新，接下来就执行<code>onRefresh()</code>。刷新转圈的动画完成时，代表了<code>onRefresh()</code>的完成，之后就让刷新图标消失。</p>
<p>下拉回弹的动画是由<code>animateOffsetToCorrectPosition()</code>开始的，也就是说刷新也是由这个方法触发的。经过简单分析后不难发现触发刷新的是<code>onTouchEvent()</code>方法。</p>
<h2 id="onInterceptTouchEvent()_V-S-_onTouchEvent()">onInterceptTouchEvent() V.S. onTouchEvent()</h2><p>在安卓触屏事件分发处理过程中这两个是关键方法。在覆写这两个方法时需要遵守一定的规则，否则会有奇怪的事情发生，具体如下：</p>
<h3 id="ViewGroup-onInterceptTouchEvent()">ViewGroup.onInterceptTouchEvent()</h3><blockquote>
<p>Implement this method to intercept all touch screen motion events. This allows you to watch events as they are dispatched to your children, and take ownership of the current gesture at any point.</p>
<p>Using this function takes some care, as it has a fairly complicated interaction with View.onTouchEvent(MotionEvent), and using it requires implementing that method as well as this one in the correct way. Events will be received in the following order:</p>
<ul>
<li>You will receive the down event here.</li>
<li>The down event will be handled either by a child of this view group, or given to your own onTouchEvent() method to handle; this means you should implement onTouchEvent() to return true, so you will continue to see the rest of the gesture (instead of looking for a parent view to handle it). Also, by returning true from onTouchEvent(), you will not receive any following events in onInterceptTouchEvent() and all touch processing must happen in onTouchEvent() like normal.</li>
<li>For as long as you return false from this function, each following event (up to and including the final up) will be delivered first here and then to the target’s onTouchEvent().</li>
<li>If you return true from here, you will not receive any following events: the target view will receive the same event but with the action ACTION_CANCEL, and all further events will be delivered to your onTouchEvent() method and no longer appear here.</li>
</ul>
</blockquote>
<h3 id="View-onTouchEvent()">View.onTouchEvent()</h3><blockquote>
<p>Implement this method to handle touch screen motion events.</p>
<p>If this method is used to detect click actions, it is recommended that the actions be performed by implementing and calling performClick(). This will ensure consistent system behavior, including:</p>
<ul>
<li>obeying click sound preferences</li>
<li>dispatching OnClickListener calls</li>
<li>handling ACTION_CLICK when accessibility features are enabled</li>
</ul>
</blockquote>
<p>从文档上来看，当一个触屏事件发生时，安卓框架会先把事件发送到<code>ViewGroup.onInterceptTouchEvent()</code>，再根据其返回的结果来决定该事件该份配给自己的<code>ViewGroup.onTouchEvent()</code>，还是 target view 的<code>View.onTouchEvent()</code>。（注意 target view 指的是 layout.xml 中嵌套在SwipeRefreshLayout里的View，或是处于SwipeRefreshLayout之下的View。）那么SwipeRefreshLayout在处理触屏事件的流程也应如此。</p>
<h2 id="SwipeRefreshLayout_对触屏事件的反应">SwipeRefreshLayout 对触屏事件的反应</h2><p>在修改SwipeRefreshLayout前，就算不清楚它的代码，那至少也要了解它对触屏事件的反馈。最直观的方法是创建一个子类，覆写那两个方法，算是曲线救国吧。具体的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SSwipeRefreshLayout</span> <span class="keyword">extends</span> <span class="title">SwipeRefreshLayout</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"SSwipe"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SSwipeRefreshLayout</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SSwipeRefreshLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> b = <span class="keyword">super</span>.onTouchEvent(ev);</span><br><span class="line">        Log.d(TAG + <span class="string">"BT"</span>, String.valueOf(b));</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> b = <span class="keyword">super</span>.onInterceptTouchEvent(ev);</span><br><span class="line">        Log.d(TAG + <span class="string">"BI"</span>, String.valueOf(b));</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="触发刷新">触发刷新</h3><h4 id="向左下滑"><strong>向左下滑</strong></h4><p><img src="http://ww2.sinaimg.cn/bmiddle/7f793092gw1ev34kpb2ldj20u01hc7an.jpg" alt=""></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">52.650</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">52.679</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">06.657</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">06.790</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ true</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">06.808</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBT﹕ true  &lt;--- onTouchEvent</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">06.811</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBT﹕ true</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">06.831</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBT﹕ true</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="向右下滑"><strong>向右下滑</strong></h4><p><img src="http://ww4.sinaimg.cn/bmiddle/7f793092gw1ev34lnjl05j20u01hcn3v.jpg" alt=""></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">27.546</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">27.700</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">27.717</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">27.726</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">27.743</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">27.760</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">27.777</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">27.794</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">27.812</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ true</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">27.829</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBT﹕ true  &lt;--- onTouchEvent</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">27.845</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBT﹕ true</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">06.868</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBT﹕ true</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">04</span>:<span class="number">06.893</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBT﹕ true</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="笔直向下滑"><strong>笔直向下滑</strong></h4><p><img src="http://ww3.sinaimg.cn/bmiddle/7f793092gw1ev34m7lgjxj20u01hcdmi.jpg" alt=""></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">29</span>:<span class="number">13.798</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">29</span>:<span class="number">14.115</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">29</span>:<span class="number">14.132</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ true</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">29</span>:<span class="number">14.150</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBT﹕ true  &lt;--- onTouchEvent</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">29</span>:<span class="number">14.166</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBT﹕ true</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">29</span>:<span class="number">14.183</span>  <span class="number">10606</span>-<span class="number">10606</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBT﹕ true</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="不触发刷新">不触发刷新</h3><p>注意查看<strong>滚动条</strong>。</p>
<h4 id="向左下滑-1"><strong>向左下滑</strong></h4><p><img src="http://ww2.sinaimg.cn/bmiddle/7f793092gw1ev34y348moj20u01hc454.jpg" alt=""></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">54.169</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">54.249</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">54.273</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">54.290</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">54.307</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">54.324</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">54.341</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">54.358</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">54.375</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">54.392</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line">...                                                                                           &lt;-- <span class="function"><span class="title">onTouchEvent</span><span class="params">()</span></span> Never Called!</span><br></pre></td></tr></table></figure>
<h4 id="向右下滑-1"><strong>向右下滑</strong></h4><p><img src="http://ww2.sinaimg.cn/bmiddle/7f793092gw1ev34xmt6cjj20u01hcn3w.jpg" alt=""></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">01.868</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">02.028</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">02.050</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">02.067</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">02.084</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">02.102</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">02.119</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">24</span>:<span class="number">02.136</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line">...                                                                                           &lt;-- <span class="function"><span class="title">onTouchEvent</span><span class="params">()</span></span> Never Called!</span><br></pre></td></tr></table></figure>
<h4 id="笔直向下滑-1"><strong>笔直向下滑</strong></h4><p><img src="http://ww4.sinaimg.cn/bmiddle/7f793092gw1ev34x7oe5fj20u01hcdm9.jpg" alt=""></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">47.059</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">47.185</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">47.203</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">47.222</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">47.237</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">47.247</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line"><span class="number">08</span>-<span class="number">15</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">47.265</span>  <span class="number">28406</span>-<span class="number">28406</span>/com<span class="class">.example</span><span class="class">.android</span><span class="class">.swiperefreshlayoutbasic</span> D/SSwipeBI﹕ false</span><br><span class="line">...                                                                                           &lt;-- <span class="function"><span class="title">onTouchEvent</span><span class="params">()</span></span> Never Called!</span><br></pre></td></tr></table></figure>
<h3 id="SwipeRefreshLayout_行为总结">SwipeRefreshLayout 行为总结</h3><p>从上面两类大情况，六种小情况来看，它的行为和文档写明的一致：</p>
<ul>
<li><p>触发刷新</p>
<ul>
<li><p>当触屏发生时，事件先到达<code>onInterceptTouchEvent()</code></p>
</li>
<li><p><code>onInterceptTouchEvent()</code>收到事件后，返回<code>false</code>，则此事件会向下传递到 <strong>target view</strong> ,同时使得下一次事件也是也<strong>先经过此方法</strong>。</p>
</li>
<li><p>经过几次事件后<code>onInterceptTouchEvent()</code>返回<code>true</code>，之后的事件都<strong>不再经过此方法</strong>，也不会传给 target view，<strong>直接传给</strong><code>SwipeRefreshLayout.onTouchEvent()</code>。</p>
</li>
<li><p><code>SwipeRefreshLayout.onTouchEvent()</code>接手事件， <strong>target view</strong> 不再收到任何事件，下拉刷新的指示图标开始出现。</p>
</li>
</ul>
</li>
<li><p>不触发刷新</p>
<ul>
<li><p>当触屏发生时，事件先到达<code>onInterceptTouchEvent()</code></p>
</li>
<li><p><code>onInterceptTouchEvent()</code>收到事件后，判读为此次手势没有刷新的意图，一直返回<code>false</code>。</p>
</li>
</ul>
</li>
</ul>
<p><code>onInterceptTouchEvent()</code>返回的结果就是我们要的循环不变量，分析到此差不多就结束了，根据它的行为，可以很轻松的降低它的敏感度。</p>
<h2 id="降低_SwipeRefreshLayout_的敏感度">降低 SwipeRefreshLayout 的敏感度</h2><p><em>此小节部分内容有关 <code>MotionEvent</code>, 由于篇幅原因不再赘述。详见参考资料。</em></p>
<p>返回我们碰到问题中来，现在有个 WebView 嵌在 SwipeRefreshLayout 中，该 WebView 呈现的网页中有个图片轮播，但我们想切换图片时经常会被 SwipeRefreshLayout 打断，使切换图片的动作成为下来刷新的动作，造成使用体验上的缺陷。</p>
<p>既然 SwipeRefreshLayout 真正接手触屏事件是从 <code>onInterceptTouchEvent()</code> 返回 <code>true</code> 开始的。那我们只要触屏事件开始时判断用户是想刷新还是像切换图片。解决的思路清晰了，接下来是判断的策略</p>
<p>如何判断用户的意图？我们可以简单一点，取从 <code>ACTION_DOWN</code> 开始的两次 <code>ACTION_MOVE</code>,并计算两点所构成的直线同屏幕 <code>X</code> 轴所呈的角度：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">O                 X</span><br><span class="line">  +----------------+</span><br><span class="line">  |<span class="string">                </span>|</span><br><span class="line">  |<span class="string">        M1 +    </span>|</span><br><span class="line">  |<span class="string">         /      </span>|</span><br><span class="line">  |<span class="string">       /ang     </span>|</span><br><span class="line">  |<span class="string">  M2 + ----- X  </span>|</span><br><span class="line">  |<span class="string">                </span>|</span><br><span class="line">  |<span class="string">                </span>|</span><br><span class="line">  |<span class="string">                </span>|</span><br><span class="line">  |<span class="string">                </span>|</span><br><span class="line">  |<span class="string">                </span>|</span><br><span class="line">  |<span class="string">                </span>|</span><br><span class="line">  |<span class="string">                </span>|</span><br><span class="line">  |<span class="string">                </span>|</span><br><span class="line">Y +----------------+</span><br></pre></td></tr></table></figure>
<p>当用户手势的头两次 <code>ACTION_MOVE</code> 构成角度小于 <code>ang</code> 时就让 <code>onInterceptTouchEvent()</code> 一直返回 <code>false</code> 直到 <code>ACTION_UP</code> 为止。这样保证了 SwipeRefreshLayout 不会轻易地截断触屏事件，让 <strong>target view</strong> 有机会处理该事件，同时也保证了循环不变式的成立，不会影响 SwipeRefreshLayout 的正常工作。</p>
<h2 id="SHOW_ME_THE_CODE">SHOW ME THE CODE</h2><script src="https://gist.github.com/Overvenus/dc0ec5c4de5c27585c91.js"></script>

<p>欢迎到我的<a href="https://gist.github.com/Overvenus/dc0ec5c4de5c27585c91#file-numbswiperefreshlayout-java" target="_blank" rel="external">Gist</a>查看代码。</p>
<h3 id="NumbSwipeRefreshLayout_效果">NumbSwipeRefreshLayout 效果</h3><p>注意查看<strong>上方阴影</strong>。</p>
<p><img src="http://ww1.sinaimg.cn/bmiddle/7f793092gw1ev3c6eyty8j20u01hc0zi.jpg" alt=""><img src="http://ww4.sinaimg.cn/bmiddle/7f793092gw1ev3c6qlmwhj20u01hcwl4.jpg" alt=""></p>
<h2 id="参考资料">参考资料</h2><blockquote>
<p><a href="https://android.googlesource.com/platform/frameworks/support/+/d9df810a8e9ac28148c853249f0951329053c784/v4/java/android/support/v4/widget/SwipeRefreshLayout.java" target="_blank" rel="external">SwipeRefreshLayout 源码</a><br><a href="https://developer.android.com/reference/android/support/v4/widget/SwipeRefreshLayout.html" target="_blank" rel="external">SwipeRefreshLayout 文档</a><br><a href="https://developer.android.com/training/gestures/viewgroup.html" target="_blank" rel="external">Managing Touch Events in a ViewGroup</a><br><a href="https://developer.android.com/reference/android/view/ViewGroup.html#onInterceptTouchEvent(android.view.MotionEvent" target="_blank" rel="external">ViewGroup.onInterceptTouchEvent(MotionEvent)</a><br><a href="https://developer.android.com/reference/android/view/View.html#onTouchEvent(android.view.MotionEvent" target="_blank" rel="external">View.onTouchEvent(MotionEvent)</a><br><a href="https://developer.android.com/reference/android/view/MotionEvent.html" target="_blank" rel="external">MotionEvent</a><br><a href="http://stackoverflow.com/a/12559204/3920448" target="_blank" rel="external">Calculate gesture distance in Android — Stack Overflow</a><br><a href="http://android-developers.blogspot.com/2010/06/making-sense-of-multitouch.html" target="_blank" rel="external">Making Sense of Multitouch</a><br><a href="https://en.wikipedia.org/wiki/False_positives_and_false_negatives" target="_blank" rel="external">False positives and false negatives</a></p>
</blockquote>
<p>个人笔记，难免有误，如有发现，还望指出。<br>END.</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="PullToRefresh_与_SwipeRefreshLayout">PullToRefresh 与 SwipeRefreshLayout</h2><p>这段时间我在 Easyinking 公司实习， 做安卓开发。之前的 App 中大量使用 <a href="https://github.com/chrisbanes/Android-PullToRefreshhttps://github.com/chrisbanes/Android-PullToRefresh">Android-PullToRefresh</a>。这个轮子很经典，在较久版本的安卓上面也很好使，不过作者已经放弃维护了，在我们的 App 上也发现了一个诡异的BUG：与WebView配合使用时，在网络环境差的情况下会出现一次下拉多次刷新的情况，症状就是整个网页在那上下抽搐。在官方支持库 support-v4:22 中自带了一个类似的 SwipeRefreshLayout，效果也是一级棒。由于两者的 API 设计差不多，使用的情景也几乎一样，所以可以无痛地从 <a href="https://github.com/chrisbanes/Android-PullToRefreshhttps://github.com/chrisbanes/Android-PullToRefresh">PullToRefresh</a> 转移过来。</p>
<h2 id="敏感的_SwipeRefreshLayout">敏感的 SwipeRefreshLayout</h2><p>从 PullToRefresh 转移到 SwipeRefreshLayout 大概花了十来分钟，初步测试出来的效果也令人满意。但是，实际使用中总会有意想不到的问题。我们把一个WebView放在了 SwipeRefreshLayout 中， 该 WebView 呈现的网页中有一个图片轮播，可左右滑动，下面的问题是 SwipeRefreshLayout 过于敏感，它把稍有下拉倾向的左右滑动全部拦截掉，并把他们当作下拉的手势，典型的 False Positive ， 处理的思路也很简单，既然是误报，过滤之即可。</p>
<h3 id="误报的手势"><strong>误报的手势</strong></h3><p><img src="http://ww1.sinaimg.cn/bmiddle/7f793092gw1ev1xydoiwoj20u01hcwoe.jpg" alt=""><img src="http://ww3.sinaimg.cn/bmiddle/7f793092gw1ev1ys28bm4j20u01hc12q.jpg" alt=""></p>
<h3 id="理想中的手势"><strong>理想中的手势</strong></h3><p><img src="http://ww1.sinaimg.cn/bmiddle/7f793092gw1ev1ytgovwpj20u01hcgve.jpg" alt=""></p>]]>
    
    </summary>
    
      <category term="Android" scheme="http://neilsh.me/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[GOTO与拓扑排序]]></title>
    <link href="http://neilsh.me/2015/07/04/goto_and_topological_sorting/"/>
    <id>http://neilsh.me/2015/07/04/goto_and_topological_sorting/</id>
    <published>2015-07-04T14:26:00.000Z</published>
    <updated>2015-10-19T11:13:36.000Z</updated>
    <content type="html"><![CDATA[<h2 id="goto_in_C">goto in C</h2><p><code>goto</code>在C语言中可以实现无限制跳转，现在有很多人都建议在实际编程中使用它，因为它会使程序的控制流程(control flow)变得混乱，难以阅读。</p>
<h3 id="goto,_break,_continue">goto, break, continue</h3><p><code>goto</code>,<code>break</code>,<code>continue</code> 三者都可以打断控制流程，但后两者都是有限制的，只能打断当前的<code>{}</code>(scope)。<br><code>continue</code> 只能写在loop里，不然编译报：continue statement not within loop，<br><code>break</code>只能写在loop或者switch中，不然编译报：break statement not within loop or switch。<br><code>goto</code>则不同，它可写在和跳转到函数的任意行，自由度极大，一个不小心就会有bug，这样的代码通常也难以维护。不过用的好当然也可以增加效率的同时提到可读性。<br><a id="more"></a></p>
<blockquote>
<p>I think goto’s are fine, and they are often more readable than large<br>amounts of indentation. That’s <em>especially</em> true if the code flow isn’t<br>actually naturally indented (in this case it is, so I don’t think using<br>goto is in any way <em>clearer</em> than not, but in general goto’s can be quite<br>good for readability).<br>—-Linus</p>
</blockquote>
<h2 id="拓扑排序">拓扑排序</h2><p>《算法导论》中拓扑排序的例子，粉色的是各物件的依赖图，青色的是拓扑排序图。<br><img src="http://ww4.sinaimg.cn/large/7f793092gw1ets46e3xppj20ok0kcq4d.jpg" alt=""><br>根据图，如果还没穿内裤，拿就必须要穿内裤那个节点开始走起；如果已经穿好内裤和裤子了，那从腰带开始走起便可。<br>可以看出，拓扑排序图中的各物件的依赖关系与箭头相反，不管从哪点进入，最终的还是会到同一个节点。</p>
<h2 id="内存管理引发的思考">内存管理引发的思考</h2><p>在JOS的内存管理模块中，有一个<code>page_insert</code>的函数，它负责记录<code>page</code>的地址和权限，这个函数最终的结果只有一个，但输入有多种情况，为了处理这些情况，势必要写多个判断。<br>插入的<code>pagetable</code>中对应该<code>page</code>的条目是否有旧纪录？如果没有直接插入，设置权限，结束；如果有，是否同一个<code>page</code>，如果同一个，设置新权限，结束；如果不是同一个，删掉旧记录，插入该<code>page</code>地址，设置权限，结束。<br>大致的逻辑请看下图：<br><img src="http://ww3.sinaimg.cn/large/7f793092gw1etufs6cjxnj20av0m1gmq.jpg" alt=""></p>
<p>从描述可知，只有条件跳转来处理这些情况会有许多重复的代码，而且不直观，难以理解。</p>
<h3 id="不用goto的page_insert">不用<code>goto</code>的<code>page_insert</code></h3><p>无<code>goto</code>，但代码重复，判断层级过多，不易理解。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">page_insert</span><span class="params">(pde_t *pgdir, <span class="keyword">struct</span> PageInfo *pp, <span class="keyword">void</span> *va, <span class="keyword">int</span> perm)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">pte_t</span> *va_pte = pgdir_walk(pgdir, va, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (! va_pte)</span><br><span class="line">		<span class="comment">// E_NO_MEM, if page table couldn't be allocated</span></span><br><span class="line">		<span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">physaddr_t</span> pp_pa = page2pa(pp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((*va_pte) &amp; PTE_P) &#123;</span><br><span class="line">		<span class="comment">// There is something in this pte.</span></span><br><span class="line">		<span class="keyword">if</span> (PTE_ADDR(*va_pte) == pp_pa) &#123;</span><br><span class="line">			<span class="comment">// Re-insert</span></span><br><span class="line">			*va_pte = pp_pa | perm | PTE_P;</span><br><span class="line">			<span class="keyword">if</span> (perm | PTE_U)</span><br><span class="line">				<span class="comment">// Changes to User Table</span></span><br><span class="line">				pgdir[PDX(va)] |= PTE_U;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Different page</span></span><br><span class="line">		page_remove(pgdir, va);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Nothing in this PTE</span></span><br><span class="line">	*va_pte = pp_pa | perm | PTE_P;</span><br><span class="line">	<span class="keyword">if</span> (perm | PTE_U)</span><br><span class="line">		<span class="comment">// Changes to User Table</span></span><br><span class="line">		pgdir[PDX(va)] |= PTE_U;</span><br><span class="line"></span><br><span class="line">	pp-&gt;pp_ref += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="使用goto的page_insert">使用<code>goto</code>的<code>page_insert</code></h3><p>有<code>goto</code>，但代码不重复，跳转层级少，直观。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">page_insert</span><span class="params">(pde_t *pgdir, <span class="keyword">struct</span> PageInfo *pp, <span class="keyword">void</span> *va, <span class="keyword">int</span> perm)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">pte_t</span> *va_pte = pgdir_walk(pgdir, va, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (! va_pte)</span><br><span class="line">		<span class="comment">// E_NO_MEM, if page table couldn't be allocated</span></span><br><span class="line">		<span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">physaddr_t</span> pp_pa = page2pa(pp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (! (*va_pte) &amp; PTE_P)</span><br><span class="line">		<span class="comment">// Nothing in this PTE</span></span><br><span class="line">		<span class="keyword">goto</span> nonpresent;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// There is something in this pte.</span></span><br><span class="line">	<span class="keyword">if</span> (PTE_ADDR(*va_pte) == pp_pa)</span><br><span class="line">		<span class="comment">// Re-insert</span></span><br><span class="line">		<span class="keyword">goto</span> present_same;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="comment">// Different page</span></span><br><span class="line">		<span class="keyword">goto</span> present_different;</span><br><span class="line"></span><br><span class="line">	present_different:</span><br><span class="line">		page_remove(pgdir, va);</span><br><span class="line"></span><br><span class="line">	nonpresent:</span><br><span class="line">		*va_pte = pp_pa;</span><br><span class="line">		pp-&gt;pp_ref += <span class="number">1</span>;</span><br><span class="line">		tlb_invalidate(pgdir, va);</span><br><span class="line"></span><br><span class="line">	present_same:</span><br><span class="line">		*va_pte = pp_pa | perm | PTE_P;</span><br><span class="line">		<span class="keyword">if</span> (perm &amp; PTE_U)</span><br><span class="line">			<span class="comment">// Commits to User Table</span></span><br><span class="line">			pgdir[PDX(va)] |= PTE_U;</span><br><span class="line">		<span class="keyword">if</span> (perm &amp; PTE_W)</span><br><span class="line">			pgdir[PDX(va)] |= PTE_W;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结">总结</h2><ul>
<li><code>goto</code>最好与判断写在一起，方便从语意理解此语句。</li>
<li>如果出口只有一个，进口有多个，可适当用<code>goto</code>，符合DRY。</li>
</ul>
<h3 id="Another_fancy_case">Another fancy case</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// error handler</span></span><br><span class="line">swith(i) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        foo();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        bar();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        n = dosth_1();</span><br><span class="line">        <span class="keyword">if</span> (n)</span><br><span class="line">            <span class="keyword">goto</span> bad;</span><br><span class="line">        n = dosth_2();</span><br><span class="line">        <span class="keyword">if</span> (n)</span><br><span class="line">            <span class="keyword">goto</span> bad:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    bad:</span><br><span class="line">        report();</span><br><span class="line">        <span class="keyword">end_t</span>his();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="更多资料">更多资料</h3><blockquote>
<p><a href="https://en.wikipedia.org/wiki/Gotohttps://en.wikipedia.org/wiki/Goto" target="_blank" rel="external">https://en.wikipedia.org/wiki/Gotohttps://en.wikipedia.org/wiki/Goto</a><br><a href="https://en.wikipedia.org/wiki/Topological_sorting" target="_blank" rel="external">https://en.wikipedia.org/wiki/Topological_sorting</a><br><a href="https://web.archive.org/web/20051128093253/http://kerneltrap.org/node/553/2131" target="_blank" rel="external">https://web.archive.org/web/20051128093253/http://kerneltrap.org/node/553/2131</a><br>Knuth, Donald E. “Structured Programming with go to Statements.” ACM Computing Surveys (CSUR) 6, no. 4 (1974): 261-301.</p>
</blockquote>
<p>个人笔记，难免有误，如有发现，还望指出。<br>END.</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="goto_in_C">goto in C</h2><p><code>goto</code>在C语言中可以实现无限制跳转，现在有很多人都建议在实际编程中使用它，因为它会使程序的控制流程(control flow)变得混乱，难以阅读。</p>
<h3 id="goto,_break,_continue">goto, break, continue</h3><p><code>goto</code>,<code>break</code>,<code>continue</code> 三者都可以打断控制流程，但后两者都是有限制的，只能打断当前的<code>{}</code>(scope)。<br><code>continue</code> 只能写在loop里，不然编译报：continue statement not within loop，<br><code>break</code>只能写在loop或者switch中，不然编译报：break statement not within loop or switch。<br><code>goto</code>则不同，它可写在和跳转到函数的任意行，自由度极大，一个不小心就会有bug，这样的代码通常也难以维护。不过用的好当然也可以增加效率的同时提到可读性。<br>]]>
    
    </summary>
    
      <category term="Algorithms" scheme="http://neilsh.me/tags/Algorithms/"/>
    
      <category term="C" scheme="http://neilsh.me/tags/C/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[内核的启动和建立虚拟内存]]></title>
    <link href="http://neilsh.me/2015/07/02/os_setup_and_virtual_memory_setup/"/>
    <id>http://neilsh.me/2015/07/02/os_setup_and_virtual_memory_setup/</id>
    <published>2015-07-02T10:02:00.000Z</published>
    <updated>2015-10-19T11:13:36.000Z</updated>
    <content type="html"><![CDATA[<h2 id="引言">引言</h2><p>这篇博文写 JOS 如何建立虚拟内存，同时也是 MIT6.828 Lab2 的答案。<br>JOS 是 MIT6.828 操作系统课程中给学生练习用的小型内核。JOS 是一个 X86 平台的32位操作系统，它是根据 Unix 第6版 设计的，也就是这篇paper <a href="http://pdos.csail.mit.edu/6.828/2014/readings/ritchie78unix.pdf" target="_blank" rel="external">The UNIX Time-Sharing System</a>。</p>
<h2 id="MMU的工作机制">MMU的工作机制</h2><p><code>MMU</code>是 x86 CPU 集成的一个硬件，负责把虚拟地址翻译成物理地址。增加一层翻译不是会降低性能，那为什么不直接用物理地址？这是因为设计 Computer 和 OS 的 Scientists 为了实现不同应用程序之间的 isolation 以增加 safety 和降低应用程序的 Complexity。<br><code>MMU</code>在计算机启动初期是不工作的，只有寄存器<code>cr0</code>中的flag打开，它才会工作。</p>
<p>本文写最简单的32位虚拟内存机制，同样也是 JOS 用的。<br>先祭出一张神图，这张图生动形象的说明了<code>MMU</code>的工作流程：<br><a id="more"></a><br><img src="http://ww1.sinaimg.cn/large/7f793092gw1etosykok6uj216o1kwdq0.jpg" alt=""><br>术语说明：</p>
<blockquote>
<p><code>page</code>: <code>MMU</code> 在逻辑上把内存分割为一个一个4KB大小的块。<br><code>page table</code>: 一个 <code>page</code>，大小4KB，内容是<em>1024个</em>指向不同 <code>page</code> 的地址及其权限。<br><code>page directory</code>：一个 <code>page</code>，大小4KB，内容是<em>1024个</em>指向不同 <code>page table</code> 的地址及其权限。<br><code>cr3</code>: x86 CPU 中的一个寄存器，存有一个32位的地址，指向一个 <code>page directory</code>。</p>
</blockquote>
<p>单个<code>page</code>的寻址：</p>
<blockquote>
<p>4KB = 4096 = 0x1000</p>
</blockquote>
<p>由于每一个 <code>page</code> 都是4KB，它们的起始地址是<em>0x?????000</em>，以3个0x0结尾，所以<em>真正有效</em>的数据是前20bits。之后的12bits可用来设置该 <code>page</code>的权限。这也解释了为什么神图中仅靠前20bits的<code>PPN</code>就能找到对应的<code>page</code>。</p>
<p>一个<code>page directory</code>足以映射4GB的内存：</p>
<blockquote>
<p>1 x 1024 x 1024 x (4 x 1024) = 4GB<br>one <code>cr3</code> points to one <code>page directory</code><br>one <code>page directory</code> has 1024 <code>page tables</code><br>one <code>page table</code> has 1024 <code>pages</code><br>one <code>page</code> has 4KB memory</p>
</blockquote>
<h2 id="BootLoader_到内核">BootLoader 到内核</h2><p>BIOS 把硬盘第一个扇区的数据(BootLoader)加载到内存物理地址<code>0x7c00</code>后，便把<code>eip = 7c00</code>，CPU 开始执行内存<code>7c00</code>处(BootLoader)的代码，此时 CPU 还未开启 <code>PAGING</code>，并处于16位模式。BootLoager要做的就是关闭中断，开启保护模式，进入32位工作状态，并且把硬盘中的内核加载代内存<code>0x10000</code>处，然后把硬件的使用权移交给内核。</p>
<h2 id="内核初期的内存映射">内核初期的内存映射</h2><h3 id="开启_MMU">开启 MMU</h3><p>内核接管硬件后，所有的地址都是物理地址，<code>eip</code>寄存器指向物理地址的内核指令。之后，内核第一时间开启了<code>MMU</code>。下面是 JOS 内核启动的头几条汇编代码，在<code>entry.S</code>文件中。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line"><span class="preprocessor"># The Multiboot header</span></span><br><span class="line">.align <span class="number">4</span></span><br><span class="line">.<span class="keyword">long</span> MULTIBOOT_HEADER_MAGIC</span><br><span class="line">.<span class="keyword">long</span> MULTIBOOT_HEADER_FLAGS</span><br><span class="line">.<span class="keyword">long</span> CHECKSUM</span><br><span class="line"></span><br><span class="line"><span class="preprocessor"># '_start' specifies the ELF entry point.  Since we haven't set up</span></span><br><span class="line"><span class="preprocessor"># virtual memory when the bootloader enters this code, we need the</span></span><br><span class="line"><span class="preprocessor"># bootloader to jump to the *physical* address of the entry point.</span></span><br><span class="line">.globl		_start</span><br><span class="line">_start = RELOC(entry)</span><br><span class="line"></span><br><span class="line">.globl entry</span><br><span class="line">entry:</span><br><span class="line">	movw	$<span class="number">0x1234</span>,<span class="number">0x472</span>			<span class="preprocessor"># warm boot</span></span><br><span class="line"></span><br><span class="line">    <span class="preprocessor"># entry_pgdir 是 page directory，被硬编码在内核中。</span></span><br><span class="line">	movl	$(RELOC(entry_pgdir)), %eax</span><br><span class="line">	movl	%eax, %cr3</span><br><span class="line">	<span class="preprocessor"># Turn on paging.  开启 PAGING</span></span><br><span class="line">	movl	%cr0, %eax</span><br><span class="line">	orl	$(CR0_PE|CR0_PG|CR0_WP), %eax</span><br><span class="line">	movl	%eax, %cr0</span><br><span class="line"><span class="preprocessor">#接下面的汇编代码</span></span><br></pre></td></tr></table></figure></p>
<p>但此时虚拟内存还没有建立，代码操作的地址还是物理地址，所用的 page directory 及 page table 硬编码在内核中，虚拟地址和物理地址是<em>一对一且连续映射</em>的。<br>下面是硬编码在内核中的 page directory。大意就是虚拟地址<code>0x0000 0000～0x0040 0000</code>和<code>0xF000 0000～0xF040 0000</code>都映射到物理地址<code>0x0000 0000～0x0040 0000</code>，且是<em>连续一对一映射</em>。换句话说，整个内核的虚拟地址就是物理地址加上<code>KERNBASE</code>，详细下面内核结构会解释。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> KERNBASE 0xF0000000</span></span><br><span class="line">__attribute__((__aligned__(PGSIZE)))  <span class="comment">// 4KB 对齐</span></span><br><span class="line"><span class="keyword">pde_t</span> entry_pgdir[<span class="number">1024</span>] = &#123;</span><br><span class="line">	<span class="comment">// Map VA's [0, 4MB) to PA's [0, 4MB)</span></span><br><span class="line">	[<span class="number">0</span>]</span><br><span class="line">		= ((<span class="keyword">uintptr_t</span>)entry_pgtable - KERNBASE) + PTE_P,</span><br><span class="line">	<span class="comment">// Map VA's [KERNBASE, KERNBASE+4MB) to PA's [0, 4MB)</span></span><br><span class="line">	[KERNBASE&gt;&gt;<span class="number">22</span>]</span><br><span class="line">		= ((<span class="keyword">uintptr_t</span>)entry_pgtable - KERNBASE) + PTE_P + PTE_W</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>不过这样做还是有问题，这个 page directory 及其 page table 必须要在内存开始的头4MB之内，不然MMU就会报错。不过幸好，我们的内核还不大，4MB足够装下，实际上还有许多空闲的空间。</p>
<h3 id="工作在虚拟地址">工作在虚拟地址</h3><p>开启<code>MMU</code>后，所有对内存的操作都会经过翻译，CPU 的<code>eip</code>寄存器还是指向低位的物理地址，为了后续代码的正常工作，我们要把它转化为指向高位的虚拟地址，在 JOS 这个转化很简单，其实质就是加上<code>KERNBASE</code>，理由见上面<code>entry_pgdir</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#接上面的汇编代码。</span></span><br><span class="line">	<span class="preprocessor"># Now paging is enabled, but we're still running at a low EIP</span></span><br><span class="line">	<span class="preprocessor"># (why is this okay?).  Jump up above KERNBASE before entering</span></span><br><span class="line">	<span class="preprocessor"># C code.</span></span><br><span class="line">	mov	$relocated, %eax</span><br><span class="line">	jmp	*%eax</span><br><span class="line">relocated:  <span class="preprocessor"># 此处的虚拟地址=物理地址+KERNBASE</span></span><br><span class="line">    <span class="preprocessor"># ...</span></span><br></pre></td></tr></table></figure>
<p><code>jmp</code>之后内存就正式工作完成初期的<code>PAGING</code>。<br>为什么要<code>jmp</code>一下（疑惑脸）？请看<code>内核的结构</code>。</p>
<h3 id="内核的结构">内核的结构</h3><p>我<em>认为（可能有错，还没学过编译）</em>：</p>
<blockquote>
<p>JOS 的内核是虚拟按地址链接的，所有<code>symbol</code>（，代码和静态变量？）的地址都是虚拟地址（对于内核初期来说）。</p>
</blockquote>
<p>这句话是什么意思？请看内核的链接文件。<br><figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ENTRY<span class="params">(_start)</span></span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* Link the kernel at this address: "." means the current address */</span></span><br><span class="line">	. = <span class="number">0</span>xF0100000;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* AT(...) gives the load address of this section, which tells</span><br><span class="line">	   the boot loader where to load the kernel in physical memory */</span></span><br><span class="line">	.<span class="built_in">text</span> : AT<span class="params">(<span class="number">0</span>x100000)</span> &#123;</span><br><span class="line">		<span class="built_in">*</span><span class="params">(.text .stub .text.* .gnu.linkonce.t.*)</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	PROVIDE<span class="params">(etext = .)</span>;	<span class="comment">/* Define the 'etext' symbol to this value */</span></span><br><span class="line">    <span class="comment">/* ... */</span></span><br></pre></td></tr></table></figure></p>
<p>用这链接文件编译出的内核的 section headers 如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -h obj/kern/kernel&#10;&#10;obj/kern/kernel:     file format elf32-i386&#10;Sections:&#10;Idx Name          Size      VMA       LMA       File off  Algn&#10;  0 .text         00001947  f0100000  00100000  00001000  2**4&#10;                  CONTENTS, ALLOC, LOAD, READONLY, CODE&#10;  1 .rodata       00000770  f0101960  00101960  00002960  2**5&#10;                  CONTENTS, ALLOC, LOAD, READONLY, DATA&#10;  2 .stab         00003919  f01020d0  001020d0  000030d0  2**2&#10;                  CONTENTS, ALLOC, LOAD, READONLY, DATA&#10;  3 .stabstr      00001907  f01059e9  001059e9  000069e9  2**0&#10;                  CONTENTS, ALLOC, LOAD, READONLY, DATA&#10;  4 .data         0000a300  f0108000  00108000  00009000  2**12&#10;                  CONTENTS, ALLOC, LOAD, DATA&#10;  5 .bss          00000644  f0112300  00112300  00013300  2**5&#10;                  ALLOC&#10;  6 .comment      00000024  00000000  00000000  00013300  2**0&#10;                  CONTENTS, READONLY</span><br></pre></td></tr></table></figure>
<p><code>VMA</code>：virtual memory address | <code>LMA</code>：load memory address<br><code>0 .text         00001947  f0100000  00100000  00001000  2**4</code>，<br><code>.text</code>的虚拟地址是<code>0xf0100000</code>，加载地址（执行地址）<code>0x00100000</code>。<br>内核的第一条指令在内存<code>0x00100000</code>处，<code>eip = 0x00100000</code>，虚拟地址是<code>0xf0100000</code>。</p>
<p>再看内核的 symbol table：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -t obj/kern/kernel | sed &#39;1,/SYMBOL TABLE/d; s/ .* / /; /^$$/d&#39;&#10;addr.      sym.&#10;0010000c T _start&#10;f010000c T entry&#10;f010002f t relocated&#10;f010003e t spin&#10;f0100040 T i386_init&#10;f0100094 T _panic&#10;f01000f3 T _warn&#10;...</span><br></pre></td></tr></table></figure>
<p><code>0010000c T _start</code> 和 <code>f010000c T entry</code> 它们就是上面的汇编代码中的<code>_start</code> 和 <code>entry</code>。<br>这意味着 <code>0010000c</code> 和 <code>f010000c</code> 指向的是同一处。因为内核从<code>f010000c</code>开始链接，所以<code>relocated</code>处于高位（即虚拟地址）。<code>jmp</code>是为了使<code>eip</code>指向虚拟地址的内核代码。<code>mov</code>是为了防止 assembler 把<code>jmp</code>“优化”掉。</p>
<h3 id="内核建立虚拟内存">内核建立虚拟内存</h3><p>完成上面的工作之后，内核开始建立虚拟内存。<br><code>pmap.c</code>是 JOS 的内存管理的源码文件。下面是一些关键的全局变量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// These variables are set by i386_detect_memory()</span></span><br><span class="line"><span class="keyword">size_t</span> npages;			<span class="comment">// Amount of physical memory (in pages)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">size_t</span> npages_basemem;	<span class="comment">// Amount of base memory (in pages)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// These variables are set in mem_init()</span></span><br><span class="line"><span class="keyword">pde_t</span> *kern_pgdir;		<span class="comment">// Kernel's initial page directory</span></span><br><span class="line"><span class="comment">// 用来代表`page`的结构体</span></span><br><span class="line"><span class="keyword">struct</span> PageInfo *pages;		<span class="comment">// Physical page state array</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> PageInfo *page_free_list;	<span class="comment">// Free list of physical pages</span></span><br></pre></td></tr></table></figure>
<p><code>void mem_init(void);</code>这函数初始化硬件的全部内存并建立虚拟内存。下面我节选了部分代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mem_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Find out how much memory the machine has (npages &amp; npages_basemem).</span></span><br><span class="line">	<span class="comment">// 首先探测所有的机器有多少内存</span></span><br><span class="line">	i386_detect_memory();</span><br><span class="line">	<span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line">	<span class="comment">// create initial page directory.</span></span><br><span class="line">	<span class="comment">// 用一个简易的 alloc 函数为变量`kern_pgdir`申请一个`page`，</span></span><br><span class="line">	<span class="comment">// 此`page`在kernel之后。`kern_pgdir`指向一个高位的虚拟地址。</span></span><br><span class="line">	kern_pgdir = (<span class="keyword">pde_t</span> *) boot_alloc(PGSIZE);</span><br><span class="line">	<span class="built_in">memset</span>(kern_pgdir, <span class="number">0</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 把`kern_pgdir`所在的 page 的低位物理地址插入到`kern_pgdir`对应的槽中，</span></span><br><span class="line">	<span class="comment">// 并设置权限。Permissions: kernel R, user R</span></span><br><span class="line">	kern_pgdir[PDX(UVPT)] = PADDR(kern_pgdir) | PTE_U | PTE_P;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 为`PageInfo`申请空间，物理内存有多少就申请多少个`PageInfo`，这个链表在`kern_pgdir`之后</span></span><br><span class="line">	<span class="comment">// 这些`PageInfo`是为了新的内存管理机制做准备的，用以跟踪各`page`的使用情况。</span></span><br><span class="line">	pages = (<span class="keyword">struct</span> PageInfo *)boot_alloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> PageInfo) * npages);</span><br><span class="line">	<span class="comment">// 等等。。。</span></span><br><span class="line">```	</span><br><span class="line"></span><br><span class="line">此时的物理内存的使用情况是这样的：</span><br></pre></td></tr></table></figure>
<pre><code>[BASEMEM] &lt;------------- 0x00000000
<span class="bullet">...
</span><span class="bullet">...   </span>640KB
<span class="bullet">...
</span>[IOPHYSMEM] &lt;----------- 0x000A0000
<span class="bullet">...
</span><span class="bullet">...   </span>I/O hole
<span class="bullet">...
</span>[EXTPHYSMEM] &lt;---------- 0x00100000
<span class="bullet">...
</span>extern char entry[]; &lt;-- 0x0010000c
<span class="bullet">...
</span><span class="bullet">...   </span>kernel
<span class="bullet">...
</span>extern char end[]; &lt;---- 0x00113970
<span class="bullet">...
</span><span class="bullet">...   </span>由于4KB对齐，这会有空白
<span class="bullet">...
</span><span class="code">`kern_pgdir`</span>
<span class="bullet">...
</span><span class="bullet">....  </span>one page gap
<span class="bullet">...
</span><span class="code">`pages`</span> itself!
<span class="bullet">...   </span>used!
<span class="bullet">...   </span>...
<span class="bullet">...   </span>used!
<span class="bullet">...   </span>unused!
</code></pre><figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">之后的一些函数根据上面的图把已用的内存记录到`kern_pgdir`和`pagetable`中并设置权限。记录的方法大致是这样的：</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line"><span class="comment">// addr &gt;&gt; 22 取前10位</span></span><br><span class="line"><span class="comment">// (addr &gt;&gt;12) &amp; 0x3FF 取中间10位</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// log virtual_addr</span></span><br><span class="line">pagetable_phys_addr = kern_pgdir[virtual_addr&gt;&gt;<span class="number">22</span>]</span><br><span class="line">pagetable_phys_addr[<span class="params">(virtual_addr&gt;&gt;<span class="number">12</span>)</span> &amp; <span class="number">0</span>x3FF] = page_phys_addr</span><br><span class="line"></span><br><span class="line"><span class="comment">// `MMU` workflow</span></span><br><span class="line"><span class="comment">// virtual_addr to physical_addr</span></span><br><span class="line">pagetable_phys_addr = kern_pgdir[<span class="params">(virtual_addr)</span>&gt;&gt;<span class="number">22</span>]</span><br><span class="line">page_phys_addr = pagetable[<span class="params">(virtual_addr&gt;&gt;<span class="number">12</span>)</span> &amp; <span class="number">0</span>x3FF]</span><br><span class="line">physical_addr = <span class="params">(page_phy_addr &amp; <span class="number">0</span>x3FF)</span> | <span class="params">(virtual_addr &amp; <span class="number">0</span>xFFFFFC00)</span></span><br></pre></td></tr></table></figure>
<p>最后，内核实现了虚拟内存，并能动态分配，可以多个虚拟地址指向同一物理地址。JOS 这种的管理方式使得<code>page</code>只有在被使用时才会记录到<code>pagetable</code>中，类似于 lazy initialization。<br>这种虚拟地址的记录方式也同样解释了为什么程序在使用一个野指针的时候会退出，因为这个野指针指向的地址该程序无权访问的可能性很大，一旦访问<code>MMU</code>会报<code>pagefault</code>，从而使程序退出。</p>
<p>完整的 pmap.c 文件在<a href="/asset/code/pmap.c">这可以获取</a>，里面有比较完整的注释。</p>
<h2 id="总结">总结</h2><p>JOS 内核一启动就开启<code>MMU</code>，用的<code>page directory</code>是手写的预先编译在内核中的。之后再建立一个新的<code>page directory</code>，这个<code>page directory</code>是可以动态增加减少记录的，此时 JOS 内存的初始化算是完成了。</p>
<p>个人笔记，难免有误，如有发现，还望指出。<br>END.</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="引言">引言</h2><p>这篇博文写 JOS 如何建立虚拟内存，同时也是 MIT6.828 Lab2 的答案。<br>JOS 是 MIT6.828 操作系统课程中给学生练习用的小型内核。JOS 是一个 X86 平台的32位操作系统，它是根据 Unix 第6版 设计的，也就是这篇paper <a href="http://pdos.csail.mit.edu/6.828/2014/readings/ritchie78unix.pdf">The UNIX Time-Sharing System</a>。</p>
<h2 id="MMU的工作机制">MMU的工作机制</h2><p><code>MMU</code>是 x86 CPU 集成的一个硬件，负责把虚拟地址翻译成物理地址。增加一层翻译不是会降低性能，那为什么不直接用物理地址？这是因为设计 Computer 和 OS 的 Scientists 为了实现不同应用程序之间的 isolation 以增加 safety 和降低应用程序的 Complexity。<br><code>MMU</code>在计算机启动初期是不工作的，只有寄存器<code>cr0</code>中的flag打开，它才会工作。</p>
<p>本文写最简单的32位虚拟内存机制，同样也是 JOS 用的。<br>先祭出一张神图，这张图生动形象的说明了<code>MMU</code>的工作流程：<br>]]>
    
    </summary>
    
      <category term="C" scheme="http://neilsh.me/tags/C/"/>
    
      <category term="C.S.笔记" scheme="http://neilsh.me/tags/C-S-%E7%AC%94%E8%AE%B0/"/>
    
      <category term="MIT" scheme="http://neilsh.me/tags/MIT/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Hello World]]></title>
    <link href="http://neilsh.me/2015/06/29/hello-world/"/>
    <id>http://neilsh.me/2015/06/29/hello-world/</id>
    <published>2015-06-29T13:36:00.000Z</published>
    <updated>2015-10-19T11:13:36.000Z</updated>
    <content type="html"><![CDATA[<p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<a id="more"></a>
<h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>Welcome to <a href="http://hexo.io/">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>]]>
    
    </summary>
    
  </entry>
  
</feed>
